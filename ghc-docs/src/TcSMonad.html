<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcSMonad.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs -w #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>-- Type definitions for the constraint solver</span>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcSMonad</span> <span class='hs-layout'>(</span> 
<a name="line-10"></a>
<a name="line-11"></a>       <span class='hs-comment'>-- Canonical constraints, definition is now in TcRnTypes</span>
<a name="line-12"></a>
<a name="line-13"></a>    <span class='hs-conid'>WorkList</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWorkList</span><span class='hs-layout'>,</span>
<a name="line-14"></a>    <span class='hs-varid'>workListFromEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>workListFromNonEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>workListFromCt</span><span class='hs-layout'>,</span> 
<a name="line-15"></a>    <span class='hs-varid'>extendWorkListEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListFunEq</span><span class='hs-layout'>,</span> 
<a name="line-16"></a>    <span class='hs-varid'>extendWorkListNonEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListCt</span><span class='hs-layout'>,</span> 
<a name="line-17"></a>    <span class='hs-varid'>extendWorkListCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>appendWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>selectWorkItem</span><span class='hs-layout'>,</span>
<a name="line-18"></a>    <span class='hs-varid'>withWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>workListSize</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-varid'>updWorkListTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updWorkListTcS_return</span><span class='hs-layout'>,</span>
<a name="line-21"></a>    
<a name="line-22"></a>    <span class='hs-varid'>updTcSImplics</span><span class='hs-layout'>,</span> 
<a name="line-23"></a>
<a name="line-24"></a>    <span class='hs-conid'>Ct</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Xi</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarsOfCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarsOfCts</span><span class='hs-layout'>,</span> 
<a name="line-25"></a>    <span class='hs-varid'>emitInsoluble</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-varid'>isWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerived</span><span class='hs-layout'>,</span> 
<a name="line-28"></a>    <span class='hs-varid'>isGivenCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWantedCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerivedCt</span><span class='hs-layout'>,</span> 
<a name="line-29"></a>
<a name="line-30"></a>    <span class='hs-varid'>canRewrite</span><span class='hs-layout'>,</span> <span class='hs-varid'>canSolve</span><span class='hs-layout'>,</span>
<a name="line-31"></a>    <span class='hs-varid'>mkGivenLoc</span><span class='hs-layout'>,</span> 
<a name="line-32"></a>
<a name="line-33"></a>    <span class='hs-conid'>TcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSWithEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>panicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>traceTcS</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Basic functionality </span>
<a name="line-34"></a>    <span class='hs-varid'>traceFireTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>bumpStepCountTcS</span><span class='hs-layout'>,</span> 
<a name="line-35"></a>    <span class='hs-varid'>tryTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>nestTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>nestImplicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>recoverTcS</span><span class='hs-layout'>,</span>
<a name="line-36"></a>    <span class='hs-varid'>wrapErrTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapWarnTcS</span><span class='hs-layout'>,</span>
<a name="line-37"></a>
<a name="line-38"></a>    <span class='hs-comment'>-- Getting and setting the flattening cache</span>
<a name="line-39"></a>    <span class='hs-varid'>addSolvedDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>addSolvedFunEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>getFlattenSkols</span><span class='hs-layout'>,</span>
<a name="line-40"></a>    
<a name="line-41"></a>    <span class='hs-varid'>deferTcSForAllEq</span><span class='hs-layout'>,</span> 
<a name="line-42"></a>    
<a name="line-43"></a>    <span class='hs-varid'>setEvBind</span><span class='hs-layout'>,</span>
<a name="line-44"></a>    <span class='hs-conid'>XEvTerm</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-45"></a>    <span class='hs-conid'>MaybeNew</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFresh</span><span class='hs-layout'>,</span> <span class='hs-varid'>freshGoals</span><span class='hs-layout'>,</span> <span class='hs-varid'>getEvTerms</span><span class='hs-layout'>,</span>
<a name="line-46"></a>
<a name="line-47"></a>    <span class='hs-varid'>xCtFlavor</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Transform a CtEvidence during a step </span>
<a name="line-48"></a>    <span class='hs-varid'>rewriteCtFlavor</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Specialized version of xCtFlavor for coercions</span>
<a name="line-49"></a>    <span class='hs-varid'>newWantedEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVarNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>instDFunConstraints</span><span class='hs-layout'>,</span>
<a name="line-50"></a>    <span class='hs-varid'>newDerived</span><span class='hs-layout'>,</span>
<a name="line-51"></a>    
<a name="line-52"></a>       <span class='hs-comment'>-- Creation of evidence variables</span>
<a name="line-53"></a>    <span class='hs-varid'>setWantedTyBind</span><span class='hs-layout'>,</span>
<a name="line-54"></a>
<a name="line-55"></a>    <span class='hs-varid'>getInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getFamInstEnvs</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- Getting the environments</span>
<a name="line-56"></a>    <span class='hs-varid'>getTopEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGblEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>getUntouchables</span><span class='hs-layout'>,</span>
<a name="line-57"></a>    <span class='hs-varid'>getTcEvBindsMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcSTyBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcSTyBindsMap</span><span class='hs-layout'>,</span>
<a name="line-58"></a>
<a name="line-59"></a>
<a name="line-60"></a>    <span class='hs-varid'>lookupFlatEqn</span><span class='hs-layout'>,</span> <span class='hs-varid'>newFlattenSkolem</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- Flatten skolems </span>
<a name="line-61"></a>
<a name="line-62"></a>        <span class='hs-comment'>-- Deque</span>
<a name="line-63"></a>    <span class='hs-conid'>Deque</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertDeque</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDeque</span><span class='hs-layout'>,</span>
<a name="line-64"></a>
<a name="line-65"></a>        <span class='hs-comment'>-- Inerts </span>
<a name="line-66"></a>    <span class='hs-conid'>InertSet</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-67"></a>    <span class='hs-varid'>getInertEqs</span><span class='hs-layout'>,</span> 
<a name="line-68"></a>    <span class='hs-varid'>emptyInert</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupInInerts</span><span class='hs-layout'>,</span> 
<a name="line-69"></a>    <span class='hs-varid'>getInertUnsolved</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkAllSolved</span><span class='hs-layout'>,</span> 
<a name="line-70"></a>    <span class='hs-varid'>prepareInertsForImplications</span><span class='hs-layout'>,</span>
<a name="line-71"></a>    <span class='hs-varid'>modifyInertTcS</span><span class='hs-layout'>,</span>
<a name="line-72"></a>    <span class='hs-varid'>insertInertItemTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionCCanMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionEqMap</span><span class='hs-layout'>,</span>
<a name="line-73"></a>    <span class='hs-varid'>getRelevantCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extractRelevantInerts</span><span class='hs-layout'>,</span>
<a name="line-74"></a>    <span class='hs-conid'>CCanMap</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtTypeMap</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFamHeadMap</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtPredMap</span><span class='hs-layout'>,</span>
<a name="line-75"></a>    <span class='hs-conid'>PredMap</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamHeadMap</span><span class='hs-layout'>,</span>
<a name="line-76"></a>    <span class='hs-varid'>partCtFamHeadMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupFamHead</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupSolvedDict</span><span class='hs-layout'>,</span>
<a name="line-77"></a>    <span class='hs-varid'>filterSolved</span><span class='hs-layout'>,</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-varid'>instDFunType</span><span class='hs-layout'>,</span>                              <span class='hs-comment'>-- Instantiation</span>
<a name="line-80"></a>    <span class='hs-varid'>newFlexiTcSTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexiTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexiTcSHelperTcS</span><span class='hs-layout'>,</span>
<a name="line-81"></a>    <span class='hs-varid'>cloneMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-82"></a>
<a name="line-83"></a>    <span class='hs-conid'>Untouchables</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTouchableMetaTyVarTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFilledMetaTyVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-84"></a>    <span class='hs-varid'>zonkTyVarsAndFV</span><span class='hs-layout'>,</span>
<a name="line-85"></a>
<a name="line-86"></a>    <span class='hs-varid'>getDefaultInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDynFlags</span><span class='hs-layout'>,</span>
<a name="line-87"></a>
<a name="line-88"></a>    <span class='hs-varid'>matchFam</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchOpenFam</span><span class='hs-layout'>,</span> 
<a name="line-89"></a>    <span class='hs-varid'>checkWellStagedDFun</span><span class='hs-layout'>,</span> 
<a name="line-90"></a>    <span class='hs-varid'>pprEq</span>                                    <span class='hs-comment'>-- Smaller utils, re-exported from TcM</span>
<a name="line-91"></a>                                             <span class='hs-comment'>-- TODO (DV): these are only really used in the </span>
<a name="line-92"></a>                                             <span class='hs-comment'>-- instance matcher in TcSimplify. I am wondering</span>
<a name="line-93"></a>                                             <span class='hs-comment'>-- if the whole instance matcher simply belongs</span>
<a name="line-94"></a>                                             <span class='hs-comment'>-- here </span>
<a name="line-95"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span> 
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-98"></a>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span> 
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span> 
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-105"></a>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcRnMonad</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcMType</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcEnv</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span> 
<a name="line-109"></a>       <span class='hs-layout'>(</span> <span class='hs-varid'>checkWellStaged</span><span class='hs-layout'>,</span> <span class='hs-varid'>topIdLvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetDefaultTys</span> <span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-125"></a>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span> 
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-130"></a>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span> 
<a name="line-132"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span> <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span><span class='hs-layout'>,</span> <span class='hs-varid'>catMaybes</span><span class='hs-layout'>,</span> <span class='hs-varid'>firstJust</span> <span class='hs-layout'>)</span>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span> <span class='hs-varid'>pSnd</span> <span class='hs-layout'>)</span>
<a name="line-135"></a>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-layout'>(</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>when</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>)</span>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TrieMap</span>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span><span class='hs-layout'>(</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-layout'>)</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-144"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}

%************************************************************************
%*									*
%*                            Worklists                                *
%*  Canonical and non-canonical constraints that the simplifier has to  *
%*  work on. Including their simplification depths.                     *
%*                                                                      *
%*									*
%************************************************************************

Note [WorkList priorities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
A WorkList contains canonical and non-canonical items (of all flavors). 
Notice that each Ct now has a simplification depth. We may 
consider using this depth for prioritization as well in the future. 

As a simple form of priority queue, our worklist separates out
equalities (wl_eqs) from the rest of the canonical constraints, 
so that it's easier to deal with them first, but the separation 
is not strictly necessary. Notice that non-canonical constraints 
are also parts of the worklist. 


Note [NonCanonical Semantics]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note that canonical constraints involve a CNonCanonical constructor. In the worklist
we use this constructor for constraints that have not yet been canonicalized such as 
   [Int] ~ [a] 
In other words, all constraints start life as NonCanonicals. 

On the other hand, in the Inert Set (see below) the presence of a NonCanonical somewhere
means that we have a ``frozen error''. 

NonCanonical constraints never interact directly with other constraints -- but they can
be rewritten by equalities (for instance if a non canonical exists in the inert, we'd 
better rewrite it as much as possible before reporting it as an error to the user)

\begin{code}
<pre><a name="line-1"></a><a name="Deque"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DQ</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Insert in RH field, remove from LH field</span>
<a name="line-2"></a>                            <span class='hs-comment'>-- First to remove is at head of LH field</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="instance%20Outputable%20(Deque%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span> <span class='hs-varop'>++</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Show first one to come out at the start</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="emptyDeque"></a><span class='hs-definition'>emptyDeque</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span>
<a name="line-8"></a><span class='hs-definition'>emptyDeque</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DQ</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="isEmptyDeque"></a><span class='hs-definition'>isEmptyDeque</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-11"></a><span class='hs-definition'>isEmptyDeque</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-keyword'>as</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>bs</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="dequeSize"></a><span class='hs-definition'>dequeSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-14"></a><span class='hs-definition'>dequeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-keyword'>as</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>bs</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="insertDeque"></a><span class='hs-definition'>insertDeque</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span>
<a name="line-17"></a><span class='hs-definition'>insertDeque</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DQ</span> <span class='hs-keyword'>as</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="appendDeque"></a><span class='hs-definition'>appendDeque</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span>
<a name="line-20"></a><span class='hs-definition'>appendDeque</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-varid'>as1</span> <span class='hs-varid'>bs1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-varid'>as2</span> <span class='hs-varid'>bs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DQ</span> <span class='hs-layout'>(</span><span class='hs-varid'>as1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>bs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>as2</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs2</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="extractDeque"></a><span class='hs-definition'>extractDeque</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Deque</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-definition'>extractDeque</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-24"></a><span class='hs-definition'>extractDeque</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>extractDeque</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DQ</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-27"></a>                                <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"extractDeque"</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="WorkList"></a><span class='hs-comment'>-- See Note [WorkList priorities]</span>
<a name="line-30"></a><a name="WorkList"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Deque</span> <span class='hs-conid'>Ct</span>
<a name="line-32"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> 
<a name="line-33"></a>                         <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a>
<a name="line-36"></a><a name="appendWorkList"></a><span class='hs-definition'>appendWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-37"></a><span class='hs-definition'>appendWorkList</span> <span class='hs-varid'>new_wl</span> <span class='hs-varid'>orig_wl</span> 
<a name="line-38"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>new_wl</span>    <span class='hs-varop'>++</span>            <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>orig_wl</span>
<a name="line-39"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>new_wl</span> <span class='hs-varop'>`appendDeque`</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>orig_wl</span>
<a name="line-40"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>new_wl</span>   <span class='hs-varop'>++</span>            <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>orig_wl</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a>
<a name="line-43"></a><a name="workListSize"></a><span class='hs-definition'>workListSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-44"></a><span class='hs-definition'>workListSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>dequeSize</span> <span class='hs-varid'>funeqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>rest</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="extendWorkListEq"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-48"></a><span class='hs-comment'>-- Extension by equality</span>
<a name="line-49"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> 
<a name="line-50"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCFunEqCan_Maybe</span> <span class='hs-varid'>ct</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListFunEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="extendWorkListFunEq"></a><span class='hs-definition'>extendWorkListFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-56"></a><span class='hs-definition'>extendWorkListFunEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> 
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertDeque</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="extendWorkListEqs"></a><span class='hs-definition'>extendWorkListEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-60"></a><span class='hs-comment'>-- Append a list of equalities</span>
<a name="line-61"></a><span class='hs-definition'>extendWorkListEqs</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>wl</span> <span class='hs-varid'>cts</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="extendWorkListNonEq"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-64"></a><span class='hs-comment'>-- Extension by non equality</span>
<a name="line-65"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> 
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="extendWorkListCt"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-69"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-70"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-71"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-72"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="extendWorkListCts"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-75"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-76"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extendWorkListCt</span> <span class='hs-varid'>wl</span> <span class='hs-varid'>cts</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="isEmptyWorkList"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-79"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-varid'>wl</span> 
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>  <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyDeque</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="emptyWorkList"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span>
<a name="line-83"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDeque</span> <span class='hs-layout'>}</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="workListFromEq"></a><span class='hs-definition'>workListFromEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-86"></a><span class='hs-definition'>workListFromEq</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="workListFromNonEq"></a><span class='hs-definition'>workListFromNonEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-89"></a><span class='hs-definition'>workListFromNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="workListFromCt"></a><span class='hs-definition'>workListFromCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-92"></a><span class='hs-comment'>-- Agnostic </span>
<a name="line-93"></a><span class='hs-definition'>workListFromCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>workListFromEq</span> <span class='hs-varid'>ct</span> 
<a name="line-94"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>workListFromNonEq</span> <span class='hs-varid'>ct</span>
<a name="line-95"></a>
<a name="line-96"></a>
<a name="line-97"></a><a name="selectWorkItem"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-98"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-varid'>wl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqs</span><span class='hs-layout'>,</span><span class='hs-varid'>feqs</span><span class='hs-layout'>,</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-100"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-101"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>fun_eqs</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_eqs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extractDeque</span> <span class='hs-varid'>fun_eqs</span>
<a name="line-102"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_eqs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-103"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-104"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span><span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-comment'>-- Pretty printing </span>
<a name="line-107"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyword'>where</span> 
<a name="line-108"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WorkList (eqs)   = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-109"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WorkList (funeqs)= "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-110"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WorkList (rest)  = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-111"></a>                <span class='hs-keyglyph'>]</span>
<a name="line-112"></a>
<a name="line-113"></a>
<a name="line-114"></a><a name="CCanMap"></a><span class='hs-comment'>-- Canonical constraint maps</span>
<a name="line-115"></a><a name="CCanMap"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> 
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CCanMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_given</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Cts</span>   <span class='hs-comment'>-- All Given</span>
<a name="line-117"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Cts</span>   <span class='hs-comment'>-- All Derived</span>
<a name="line-118"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>cts_wanted</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Cts</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- All Wanted</span>
<a name="line-119"></a>
<a name="line-120"></a><a name="keepGivenCMap"></a><span class='hs-definition'>keepGivenCMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span>
<a name="line-121"></a><span class='hs-definition'>keepGivenCMap</span> <span class='hs-varid'>cc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCCanMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts_given</span> <span class='hs-varid'>cc</span> <span class='hs-layout'>}</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="instance%20Outputable%20(CCanMap%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-124"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CCanMap</span> <span class='hs-varid'>given</span> <span class='hs-varid'>derived</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CCanMap"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>given</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>derived</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="cCanMapToBag"></a><span class='hs-definition'>cCanMapToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> 
<a name="line-127"></a><span class='hs-definition'>cCanMapToBag</span> <span class='hs-varid'>cmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>rest_wder</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-128"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>rest_wder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>rest_der</span>  <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> 
<a name="line-129"></a>        <span class='hs-varid'>rest_der</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>emptyCts</span>  <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="emptyCCanMap"></a><span class='hs-definition'>emptyCCanMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> 
<a name="line-132"></a><span class='hs-definition'>emptyCCanMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CCanMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span> <span class='hs-varid'>cts_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span> <span class='hs-layout'>}</span> 
<a name="line-133"></a>
<a name="line-134"></a><a name="updCCanMap"></a><span class='hs-definition'>updCCanMap</span><span class='hs-keyglyph'>::</span> <span class='hs-conid'>Uniquable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> 
<a name="line-135"></a><span class='hs-definition'>updCCanMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmap</span> 
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span> 
<a name="line-137"></a>      <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_wanted</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insert_into</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>  <span class='hs-layout'>}</span> 
<a name="line-138"></a>      <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_given</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insert_into</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>   <span class='hs-layout'>}</span>
<a name="line-139"></a>      <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insert_into</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-140"></a>  <span class='hs-keyword'>where</span> 
<a name="line-141"></a>    <span class='hs-varid'>insert_into</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM_C</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>singleCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="getRelevantCts"></a><span class='hs-definition'>getRelevantCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Uniquable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> 
<a name="line-144"></a><span class='hs-comment'>-- Gets the relevant constraints and returns the rest of the CCanMap</span>
<a name="line-145"></a><span class='hs-definition'>getRelevantCts</span> <span class='hs-varid'>a</span> <span class='hs-varid'>cmap</span> 
<a name="line-146"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>relevant</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionBags`</span>
<a name="line-147"></a>                     <span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>  <span class='hs-varop'>`unionBags`</span>
<a name="line-148"></a>                     <span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> 
<a name="line-149"></a>          <span class='hs-varid'>residual_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_wanted</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFromUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-150"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>cts_given</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFromUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-151"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFromUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-152"></a>      <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>relevant</span><span class='hs-layout'>,</span> <span class='hs-varid'>residual_map</span><span class='hs-layout'>)</span> 
<a name="line-153"></a>  <span class='hs-keyword'>where</span>
<a name="line-154"></a>    <span class='hs-varid'>lookup</span> <span class='hs-varid'>map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>map</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyCts</span>
<a name="line-155"></a>
<a name="line-156"></a><a name="lookupCCanMap"></a><span class='hs-definition'>lookupCCanMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Uniquable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-157"></a><span class='hs-definition'>lookupCCanMap</span> <span class='hs-varid'>a</span> <span class='hs-varid'>pick_me</span> <span class='hs-varid'>map</span>
<a name="line-158"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findEvidence</span> <span class='hs-varid'>pick_me</span> <span class='hs-varid'>possible_cts</span>
<a name="line-159"></a>  <span class='hs-keyword'>where</span>
<a name="line-160"></a>     <span class='hs-varid'>possible_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>map</span><span class='hs-layout'>)</span>   <span class='hs-varid'>a</span> <span class='hs-varop'>`plus`</span> <span class='hs-layout'>(</span>
<a name="line-161"></a>                    <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>map</span><span class='hs-layout'>)</span>  <span class='hs-varid'>a</span> <span class='hs-varop'>`plus`</span> <span class='hs-layout'>(</span>
<a name="line-162"></a>                    <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>map</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`plus`</span> <span class='hs-varid'>emptyCts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-163"></a>
<a name="line-164"></a>     <span class='hs-varid'>plus</span> <span class='hs-conid'>Nothing</span>     <span class='hs-varid'>cts2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts2</span>
<a name="line-165"></a>     <span class='hs-varid'>plus</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>cts1</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>cts2</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="findEvidence"></a><span class='hs-definition'>findEvidence</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-168"></a><span class='hs-definition'>findEvidence</span> <span class='hs-varid'>pick_me</span> <span class='hs-varid'>cts</span>
<a name="line-169"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>pick</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>cts</span>
<a name="line-170"></a>  <span class='hs-keyword'>where</span>
<a name="line-171"></a>     <span class='hs-varid'>pick</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-172"></a>     <span class='hs-varid'>pick</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>deflt</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>pick_me</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span>
<a name="line-173"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deflt</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="partitionCCanMap"></a><span class='hs-definition'>partitionCCanMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span><span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> 
<a name="line-176"></a><span class='hs-comment'>-- All constraints that /match/ the predicate go in the bag, the rest remain in the map</span>
<a name="line-177"></a><span class='hs-definition'>partitionCCanMap</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>cmap</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ws_map</span><span class='hs-layout'>,</span><span class='hs-varid'>ws</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM_Directly</span> <span class='hs-varid'>aux</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> 
<a name="line-179"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>ds_map</span><span class='hs-layout'>,</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM_Directly</span> <span class='hs-varid'>aux</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-180"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>gs_map</span><span class='hs-layout'>,</span><span class='hs-varid'>gs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM_Directly</span> <span class='hs-varid'>aux</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> 
<a name="line-181"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>ws</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>gs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_wanted</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ws_map</span>
<a name="line-182"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>cts_given</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gs_map</span>
<a name="line-183"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_map</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-184"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>aux</span> <span class='hs-varid'>k</span> <span class='hs-varid'>this_cts</span> <span class='hs-layout'>(</span><span class='hs-varid'>mp</span><span class='hs-layout'>,</span><span class='hs-varid'>acc_cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_mp</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_acc_cts</span><span class='hs-layout'>)</span>
<a name="line-185"></a>                                    <span class='hs-keyword'>where</span> <span class='hs-varid'>new_mp</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM</span> <span class='hs-varid'>mp</span> <span class='hs-varid'>k</span> <span class='hs-varid'>cts_keep</span>
<a name="line-186"></a>                                          <span class='hs-varid'>new_acc_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc_cts</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>cts_out</span>
<a name="line-187"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>cts_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>cts_keep</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBag</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>this_cts</span>
<a name="line-188"></a>
<a name="line-189"></a><a name="partitionEqMap"></a><span class='hs-definition'>partitionEqMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-190"></a><span class='hs-definition'>partitionEqMap</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>isubst</span> 
<a name="line-191"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eqs_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-varid'>extend_if_pred</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>isubst</span>
<a name="line-192"></a>        <span class='hs-varid'>eqs_in</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterVarEnv_Directly</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>isubst</span>
<a name="line-193"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqs_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqs_in</span><span class='hs-layout'>)</span>
<a name="line-194"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>extend_if_pred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>cts</span>
<a name="line-195"></a>
<a name="line-196"></a><a name="extractUnsolvedCMap"></a><span class='hs-definition'>extractUnsolvedCMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-197"></a><span class='hs-comment'>-- Gets the wanted or derived constraints</span>
<a name="line-198"></a><span class='hs-definition'>extractUnsolvedCMap</span> <span class='hs-varid'>cmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-199"></a>              <span class='hs-varop'>`unionBags`</span>  <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-200"></a>
<a name="line-201"></a><a name="CtTypeMap"></a><span class='hs-comment'>-- Maps from PredTypes to Constraints</span>
<a name="line-202"></a><a name="CtTypeMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CtTypeMap</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeMap</span>    <span class='hs-conid'>Ct</span>
<a name="line-203"></a><a name="CtPredMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CtPredMap</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PredMap</span>    <span class='hs-conid'>Ct</span>
<a name="line-204"></a><a name="CtFamHeadMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CtFamHeadMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-conid'>Ct</span>
<a name="line-205"></a>
<a name="line-206"></a><a name="PredMap"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>PredMap</span>    <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PredMap</span>    <span class='hs-layout'>{</span> <span class='hs-varid'>unPredMap</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- Indexed by TcPredType</span>
<a name="line-207"></a><a name="FamHeadMap"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unFamHeadMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- Indexed by family head</span>
<a name="line-208"></a>
<a name="line-209"></a><a name="instance%20Outputable%20(PredMap%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>PredMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-210"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PredMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-211"></a>
<a name="line-212"></a><a name="instance%20Outputable%20(FamHeadMap%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-213"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="sizePredMap"></a><span class='hs-definition'>sizePredMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-216"></a><span class='hs-definition'>sizePredMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>PredMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTypeMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-varid'>m</span>
<a name="line-217"></a>
<a name="line-218"></a><a name="emptyFamHeadMap"></a><span class='hs-definition'>emptyFamHeadMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>a</span>
<a name="line-219"></a><span class='hs-definition'>emptyFamHeadMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>emptyTM</span>
<a name="line-220"></a>
<a name="line-221"></a><a name="sizeFamHeadMap"></a><span class='hs-definition'>sizeFamHeadMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-222"></a><span class='hs-definition'>sizeFamHeadMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTypeMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-varid'>m</span>
<a name="line-223"></a>
<a name="line-224"></a><a name="ctTypeMapCts"></a><span class='hs-definition'>ctTypeMapCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-225"></a><span class='hs-definition'>ctTypeMapCts</span> <span class='hs-varid'>ctmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varid'>ctmap</span> <span class='hs-varid'>emptyCts</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="lookupFamHead"></a><span class='hs-definition'>lookupFamHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-228"></a><span class='hs-definition'>lookupFamHead</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>key</span> <span class='hs-varid'>m</span>
<a name="line-229"></a>
<a name="line-230"></a><a name="insertFamHead"></a><span class='hs-definition'>insertFamHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>a</span>
<a name="line-231"></a><span class='hs-definition'>insertFamHead</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>key</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>alterTM</span> <span class='hs-varid'>key</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>value</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="delFamHead"></a><span class='hs-definition'>delFamHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>a</span>
<a name="line-234"></a><span class='hs-definition'>delFamHead</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>alterTM</span> <span class='hs-varid'>key</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="anyFamHeadMap"></a><span class='hs-definition'>anyFamHeadMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFamHeadMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-237"></a><span class='hs-definition'>anyFamHeadMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ctmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unFamHeadMap</span> <span class='hs-varid'>ctmap</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span>
<a name="line-238"></a>
<a name="line-239"></a><a name="partCtFamHeadMap"></a><span class='hs-definition'>partCtFamHeadMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> 
<a name="line-240"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFamHeadMap</span> 
<a name="line-241"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFamHeadMap</span><span class='hs-layout'>)</span>
<a name="line-242"></a><span class='hs-definition'>partCtFamHeadMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ctmap</span>
<a name="line-243"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-varid'>tymap_final</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-varid'>upd_acc</span> <span class='hs-varid'>tymap_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>tymap_inside</span><span class='hs-layout'>)</span>
<a name="line-244"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>tymap_final</span><span class='hs-layout'>)</span>
<a name="line-245"></a>  <span class='hs-keyword'>where</span>
<a name="line-246"></a>    <span class='hs-varid'>tymap_inside</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unFamHeadMap</span> <span class='hs-varid'>ctmap</span> 
<a name="line-247"></a>    <span class='hs-varid'>upd_acc</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-varid'>acc_map</span><span class='hs-layout'>)</span>
<a name="line-248"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>alterTM</span> <span class='hs-varid'>ct_key</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc_map</span><span class='hs-layout'>)</span>
<a name="line-249"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-varid'>acc_map</span><span class='hs-layout'>)</span>
<a name="line-250"></a>         <span class='hs-keyword'>where</span> <span class='hs-varid'>ct_key</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-251"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span> 
<a name="line-252"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-253"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"partCtFamHeadMap, encountered non equality!"</span>
<a name="line-254"></a>
<a name="line-255"></a><a name="filterSolved"></a><span class='hs-definition'>filterSolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredMap</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredMap</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-256"></a><span class='hs-definition'>filterSolved</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>PredMap</span> <span class='hs-varid'>mp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PredMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldTM</span> <span class='hs-varid'>upd</span> <span class='hs-varid'>mp</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>)</span>
<a name="line-257"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>upd</span> <span class='hs-varid'>a</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>p</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>alterTM</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-258"></a>                         <span class='hs-keyword'>else</span> <span class='hs-varid'>m</span>
</pre>\end{code}

%************************************************************************
%*									*
%*                            Inert Sets                                *
%*                                                                      *
%*									*
%************************************************************************

Note [Detailed InertCans Invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The InertCans represents a collection of constraints with the following properties:
  1 All canonical
  2 All Given or Wanted or Derived. No (partially) Solved
  3 No two dictionaries with the same head
  4 No two family equations with the same head 
      NB: This is enforced by construction since we use a CtFamHeadMap for inert_funeqs
  5 Family equations inert wrt top-level family axioms
  6 Dictionaries have no matching top-level instance 
  
  7 Non-equality constraints are fully rewritten with respect to the equalities (CTyEqCan)

  8 Equalities _do_not_ form an idempotent substitution, but they are
    guaranteed to not have any occurs errors. Additional notes: 

       - The lack of idempotence of the inert substitution implies
         that we must make sure that when we rewrite a constraint we
         apply the substitution /recursively/ to the types
         involved. Currently the one AND ONLY way in the whole
         constraint solver that we rewrite types and constraints wrt
         to the inert substitution is TcCanonical/flattenTyVar.

       - In the past we did try to have the inert substitution as
         idempotent as possible but this would only be true for
         constraints of the same flavor, so in total the inert
         substitution could not be idempotent, due to flavor-related
         issued.  Note [Non-idempotent inert substitution] explains
         what is going on.

       - Whenever a constraint ends up in the worklist we do
         recursively apply exhaustively the inert substitution to it
         to check for occurs errors.  But if an equality is already in
         the inert set and we can guarantee that adding a new equality
         will not cause the first equality to have an occurs check
         then we do not rewrite the inert equality.  This happens in
         TcInteract, rewriteInertEqsFromInertEq.
         
         See Note [Delicate equality kick-out] to see which inert
         equalities can safely stay in the inert set and which must be
         kicked out to be rewritten and re-checked for occurs errors.

  9 Given family or dictionary constraints don't mention touchable unification variables

Note [Solved constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~
When we take a step to simplify a constraint 'c', we call the original constraint "solved".
For example:   Wanted:    ev  :: [s] ~ [t]
               New goal:  ev1 :: s ~ t
               Then 'ev' is now "solved".

The reason for all this is simply to avoid re-solving goals we have solved already.

* A solved Wanted may depend on as-yet-unsolved goals, so (for example) we should not
  use it to rewrite a Given; in that sense the solved goal is still a Wanted

* A solved Given is just given

* A solved Derived in inert_solved is possible; purpose is to avoid
  creating tons of identical Derived goals.

  But there are no solved Deriveds in inert_solved_funeqs

Note [Type family equations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Type-family equations, of form (ev : F tys ~ ty), live in four places

  * The work-list, of course

  * The inert_flat_cache.  This is used when flattening, to get maximal
    sharing.  It contains lots of things that are still in the work-list.
    E.g Suppose we have (w1: F (G a) ~ Int), and (w2: H (G a) ~ Int) in the
        work list.  Then we flatten w1, dumping (w3: G a ~ f1) in the work
        list.  Now if we flatten w2 before we get to w3, we still want to 
        share that (G a).

    Because it contains work-list things, DO NOT use the flat cache to solve
    a top-level goal.  Eg in the above example we don't want to solve w3 
    using w3 itself!  

  * The inert_solved_funeqs.  These are all "solved" goals (see Note [Solved constraints]),
    the result of using a top-level type-family instance.

  * THe inert_funeqs are un-solved but fully processed and in the InertCans.


\begin{code}
<pre><a name="line-1"></a><a name="InertCans"></a><span class='hs-comment'>-- All Given (fully known) or Wanted or Derived</span>
<a name="line-2"></a><a name="InertCans"></a><span class='hs-comment'>-- See Note [Detailed InertCans Invariants] for more</span>
<a name="line-3"></a><a name="InertCans"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertCans</span> 
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>Ct</span>
<a name="line-5"></a>              <span class='hs-comment'>-- Must all be CTyEqCans! If an entry exists of the form: </span>
<a name="line-6"></a>              <span class='hs-comment'>--   a |-&gt; ct,co</span>
<a name="line-7"></a>              <span class='hs-comment'>-- Then ct = CTyEqCan { cc_tyvar = a, cc_rhs = xi } </span>
<a name="line-8"></a>              <span class='hs-comment'>-- And  co : a ~ xi</span>
<a name="line-9"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-conid'>Class</span>
<a name="line-10"></a>              <span class='hs-comment'>-- Dictionaries only, index is the class</span>
<a name="line-11"></a>              <span class='hs-comment'>-- NB: index is /not/ the whole type because FD reactions </span>
<a name="line-12"></a>              <span class='hs-comment'>-- need to match the class but not necessarily the whole type.</span>
<a name="line-13"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFamHeadMap</span>
<a name="line-14"></a>              <span class='hs-comment'>-- Family equations, index is the whole family head type.</span>
<a name="line-15"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>       
<a name="line-16"></a>              <span class='hs-comment'>-- Irreducible predicates</span>
<a name="line-17"></a>
<a name="line-18"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>       
<a name="line-19"></a>              <span class='hs-comment'>-- Frozen errors (as non-canonicals)</span>
<a name="line-20"></a>       <span class='hs-layout'>}</span>
<a name="line-21"></a>    
<a name="line-22"></a>                     
<a name="line-23"></a><a name="InertSet"></a><span class='hs-comment'>-- The Inert Set</span>
<a name="line-24"></a><a name="InertSet"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertSet</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span>
<a name="line-26"></a>              <span class='hs-comment'>-- Canonical Given, Wanted, Derived (no Solved)</span>
<a name="line-27"></a>	      <span class='hs-comment'>-- Sometimes called "the inert set"</span>
<a name="line-28"></a>
<a name="line-29"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-30"></a>              <span class='hs-comment'>-- See Note [Type family equations]</span>
<a name="line-31"></a>              <span class='hs-comment'>-- Just a hash-cons cache for use when flattening only</span>
<a name="line-32"></a>              <span class='hs-comment'>-- These include entirely un-processed goals, so don't use</span>
<a name="line-33"></a>              <span class='hs-comment'>-- them to solve a top-level goal, else you may end up solving</span>
<a name="line-34"></a>              <span class='hs-comment'>-- (w:F ty ~ a) by setting w:=w!  We just use the flat-cache</span>
<a name="line-35"></a>              <span class='hs-comment'>-- when allocating a new flatten-skolem.</span>
<a name="line-36"></a>              <span class='hs-comment'>-- Not necessarily inert wrt top-level equations (or inert_cans)</span>
<a name="line-37"></a> 
<a name="line-38"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_fsks</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Rigid flatten-skolems (arising from givens)</span>
<a name="line-39"></a>                                  <span class='hs-comment'>-- allocated in this local scope</span>
<a name="line-40"></a>
<a name="line-41"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_funeqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-42"></a>              <span class='hs-comment'>-- See Note [Type family equations]</span>
<a name="line-43"></a>              <span class='hs-comment'>-- Of form co :: F xis ~ xi </span>
<a name="line-44"></a>              <span class='hs-comment'>-- Always the result of using a top-level family axiom F xis ~ tau</span>
<a name="line-45"></a>              <span class='hs-comment'>-- No Deriveds </span>
<a name="line-46"></a>              <span class='hs-comment'>-- Not necessarily fully rewritten (by type substitutions)</span>
<a name="line-47"></a>
<a name="line-48"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredMap</span> <span class='hs-conid'>CtEvidence</span> 
<a name="line-49"></a>       	      <span class='hs-comment'>-- Of form ev :: C t1 .. tn</span>
<a name="line-50"></a>              <span class='hs-comment'>-- Always the result of using a top-level instance declaration</span>
<a name="line-51"></a>              <span class='hs-comment'>-- See Note [Solved constraints]</span>
<a name="line-52"></a>       	      <span class='hs-comment'>-- - Used to avoid creating a new EvVar when we have a new goal </span>
<a name="line-53"></a>       	      <span class='hs-comment'>--   that we have solved in the past</span>
<a name="line-54"></a>       	      <span class='hs-comment'>-- - Stored not necessarily as fully rewritten </span>
<a name="line-55"></a>       	      <span class='hs-comment'>--   (ToDo: rewrite lazily when we lookup)</span>
<a name="line-56"></a>       <span class='hs-layout'>}</span>
<a name="line-57"></a>
<a name="line-58"></a>
<a name="line-59"></a><a name="instance%20Outputable%20InertCans"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyword'>where</span> 
<a name="line-60"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Equalities:"</span><span class='hs-layout'>)</span> 
<a name="line-61"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-62"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type-function equalities:"</span><span class='hs-layout'>)</span>
<a name="line-63"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> 
<a name="line-64"></a>                                  <span class='hs-varid'>ctTypeMapCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>unFamHeadMap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-65"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Dictionaries:"</span><span class='hs-layout'>)</span>
<a name="line-66"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cCanMapToBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Irreds:"</span><span class='hs-layout'>)</span>
<a name="line-68"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-69"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Insolubles ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-comment'>-- Clearly print frozen errors</span>
<a name="line-70"></a>                    <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_insols</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-71"></a>                 <span class='hs-keyglyph'>]</span>
<a name="line-72"></a>            
<a name="line-73"></a><a name="instance%20Outputable%20InertSet"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyword'>where</span> 
<a name="line-74"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>is</span>
<a name="line-75"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Solved dicts"</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>sizePredMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-76"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Solved funeqs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>sizeFamHeadMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_funeqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="emptyInert"></a><span class='hs-definition'>emptyInert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span>
<a name="line-79"></a><span class='hs-definition'>emptyInert</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-81"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCCanMap</span>
<a name="line-82"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFamHeadMap</span>
<a name="line-83"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>
<a name="line-84"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-85"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_fsks</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-86"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFamHeadMap</span>
<a name="line-87"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PredMap</span> <span class='hs-varid'>emptyTM</span> 
<a name="line-88"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFamHeadMap</span> <span class='hs-layout'>}</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="insertInertItem"></a><span class='hs-definition'>insertInertItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span> 
<a name="line-91"></a><span class='hs-comment'>-- Add a new inert element to the inert set. </span>
<a name="line-92"></a><span class='hs-definition'>insertInertItem</span> <span class='hs-varid'>item</span> <span class='hs-varid'>is</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- A canonical Given, Wanted, or Derived</span>
<a name="line-94"></a>    <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_inert_cans</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-95"></a>  
<a name="line-96"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>upd_inert_cans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-97"></a>        <span class='hs-comment'>-- Precondition: item /is/ canonical</span>
<a name="line-98"></a>        <span class='hs-varid'>upd_inert_cans</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span>
<a name="line-99"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCTyEqCan</span> <span class='hs-varid'>item</span>                     
<a name="line-100"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>upd_err</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"insertInertItem"</span> <span class='hs-varop'>$</span>
<a name="line-101"></a>                              <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Multiple inert equalities:"</span>
<a name="line-102"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Old (already inert):"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span>
<a name="line-103"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Trying to insert   :"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>]</span>
<a name="line-104"></a>        
<a name="line-105"></a>                <span class='hs-varid'>eqs'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv_C</span> <span class='hs-varid'>upd_err</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> 
<a name="line-106"></a>                                                  <span class='hs-layout'>(</span><span class='hs-varid'>cc_tyvar</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span> <span class='hs-varid'>item</span>        
<a name="line-107"></a>
<a name="line-108"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs'</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCIrredEvCan</span> <span class='hs-varid'>item</span>                  <span class='hs-comment'>-- Presently-irreducible evidence</span>
<a name="line-111"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span> <span class='hs-varop'>`</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>snocBag</span><span class='hs-varop'>`</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-112"></a>
<a name="line-113"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCDictCan_Maybe</span> <span class='hs-varid'>item</span>   <span class='hs-comment'>-- Dictionary </span>
<a name="line-114"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updCCanMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span><span class='hs-varid'>item</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-115"></a>
<a name="line-116"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-sel'>_tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCFunEqCan_Maybe</span> <span class='hs-varid'>item</span>  <span class='hs-comment'>-- Function equality</span>
<a name="line-117"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_head</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_fun</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_tyargs</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-118"></a>                <span class='hs-varid'>upd_funeqs</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>item</span>
<a name="line-119"></a>                <span class='hs-varid'>upd_funeqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-sel'>_already_there</span><span class='hs-layout'>)</span> 
<a name="line-120"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"insertInertItem: item already there!"</span>
<a name="line-121"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamHeadMap</span> 
<a name="line-122"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>alterTM</span> <span class='hs-varid'>fam_head</span> <span class='hs-varid'>upd_funeqs</span> <span class='hs-varop'>$</span> 
<a name="line-123"></a>                                         <span class='hs-layout'>(</span><span class='hs-varid'>unFamHeadMap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-124"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-125"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"upd_inert set: can't happen! Inserting "</span> <span class='hs-varop'>$</span> 
<a name="line-126"></a>            <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>   <span class='hs-comment'>-- Can't be CNonCanonical, CHoleCan, </span>
<a name="line-127"></a>                       <span class='hs-comment'>-- because they only land in inert_insols</span>
<a name="line-128"></a>
<a name="line-129"></a>
<a name="line-130"></a><a name="insertInertItemTcS"></a><span class='hs-definition'>insertInertItemTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-131"></a><span class='hs-comment'>-- Add a new item in the inerts of the monad</span>
<a name="line-132"></a><span class='hs-definition'>insertInertItemTcS</span> <span class='hs-varid'>item</span>
<a name="line-133"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"insertInertItemTcS {"</span> <span class='hs-varop'>$</span> 
<a name="line-134"></a>         <span class='hs-varid'>text</span> <span class='hs-str'>"Trying to insert new inert item:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-135"></a>
<a name="line-136"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>insertInertItem</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span> 
<a name="line-137"></a>                        
<a name="line-138"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"insertInertItemTcS }"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>}</span>
<a name="line-139"></a>
<a name="line-140"></a><a name="addSolvedDict"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-141"></a><span class='hs-comment'>-- Add a new item in the solved set of the monad</span>
<a name="line-142"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-varid'>item</span>
<a name="line-143"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIPPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Never cache "solved" implicit parameters (not sure why!)</span>
<a name="line-144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> 
<a name="line-145"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"updSolvedSetTcs:"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-147"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varid'>upd_solved_dicts</span> <span class='hs-layout'>}</span>
<a name="line-148"></a>  <span class='hs-keyword'>where</span>
<a name="line-149"></a>    <span class='hs-varid'>upd_solved_dicts</span> <span class='hs-varid'>is</span> 
<a name="line-150"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PredMap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>alterTM</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>upd_solved</span> <span class='hs-varop'>$</span> 
<a name="line-151"></a>                                  <span class='hs-varid'>unPredMap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>is</span> <span class='hs-layout'>}</span>
<a name="line-152"></a>    <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>item</span>
<a name="line-153"></a>    <span class='hs-varid'>upd_solved</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>item</span>
<a name="line-154"></a>
<a name="line-155"></a><a name="addSolvedFunEq"></a><span class='hs-definition'>addSolvedFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-156"></a><span class='hs-definition'>addSolvedFunEq</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-158"></a>    <span class='hs-varid'>inert</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertFamHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_funeqs</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span> 
<a name="line-159"></a>                                                <span class='hs-varid'>fam_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="modifyInertTcS"></a><span class='hs-definition'>modifyInertTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-162"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-163"></a><span class='hs-definition'>modifyInertTcS</span> <span class='hs-varid'>upd</span> 
<a name="line-164"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-165"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>curr_inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>is_var</span><span class='hs-layout'>)</span>
<a name="line-166"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_inert</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd</span> <span class='hs-varid'>curr_inert</span>
<a name="line-167"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-varid'>new_inert</span><span class='hs-layout'>)</span>
<a name="line-168"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="updInertTcS"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-171"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-172"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-varid'>upd</span> 
<a name="line-173"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-174"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>curr_inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>is_var</span><span class='hs-layout'>)</span>
<a name="line-175"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_inert</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd</span> <span class='hs-varid'>curr_inert</span>
<a name="line-176"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-varid'>new_inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="prepareInertsForImplications"></a><span class='hs-definition'>prepareInertsForImplications</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span>
<a name="line-179"></a><span class='hs-comment'>-- See Note [Preparing inert set for implications]</span>
<a name="line-180"></a><span class='hs-definition'>prepareInertsForImplications</span> <span class='hs-varid'>is</span>
<a name="line-181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getGivens</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-182"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_fsks</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-183"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFamHeadMap</span> <span class='hs-layout'>}</span>
<a name="line-184"></a>  <span class='hs-keyword'>where</span>
<a name="line-185"></a>    <span class='hs-varid'>getGivens</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span>
<a name="line-186"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-187"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-varid'>funeqs</span>
<a name="line-188"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-189"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterVarEnv_Directly</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqs</span> 
<a name="line-190"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamHeadMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapTM</span> <span class='hs-varid'>given_from_wanted</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>)</span>
<a name="line-191"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>filterBag</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>irreds</span>
<a name="line-192"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>keepGivenCMap</span> <span class='hs-varid'>dicts</span>
<a name="line-193"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-194"></a>
<a name="line-195"></a>    <span class='hs-varid'>given_from_wanted</span> <span class='hs-varid'>funeq</span>   <span class='hs-comment'>-- This is where the magic processing happens </span>
<a name="line-196"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGiven</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeq</span>    <span class='hs-comment'>-- for type-function equalities</span>
<a name="line-197"></a>                              <span class='hs-comment'>-- See Note [Preparing inert set for implications]</span>
<a name="line-198"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeq</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given_ev</span> <span class='hs-layout'>}</span>
<a name="line-199"></a>      <span class='hs-keyword'>where</span>
<a name="line-200"></a>        <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>funeq</span>
<a name="line-201"></a>        <span class='hs-varid'>given_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev_evar</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-202"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Preparing inert set for implications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Before solving the nested implications, we trim the inert set,
retaining only Givens.  These givens can be used when solving 
the inner implications.

With one wrinkle!  We take all *wanted* *funeqs*, and turn them into givens.
Consider (Trac #4935)
   type instance F True a b = a 
   type instance F False a b = b

   [w] F c a b ~ gamma 
   (c ~ True) => a ~ gamma 
   (c ~ False) => b ~ gamma

Obviously this is soluble with gamma := F c a b.  But
Since solveCTyFunEqs happens at the very end of solving, the only way
to solve the two implications is temporarily consider (F c a b ~ gamma)
as Given and push it inside the implications. Now, when we come
out again at the end, having solved the implications solveCTyFunEqs
will solve this equality.  

Turning type-function equalities into Givens is easy becase they 
*stay inert*.  No need to re-process them.

We don't try to turn any *other* Wanteds into Givens:

  * For example, we should not push given dictionaries in because
    of example LongWayOverlapping.hs, where we might get strange
    overlap errors between far-away constraints in the program.

There might be cases where interactions between wanteds can help
to solve a constraint. For example

  	class C a b | a -> b
  	(C Int alpha), (forall d. C d blah => C Int a)

If we push the (C Int alpha) inwards, as a given, it can produce a
fundep (alpha~a) and this can float out again and be used to fix
alpha.  (In general we can't float class constraints out just in case
(C d blah) might help to solve (C Int a).)  But we ignore this possiblity.


\begin{code}
<pre><a name="line-1"></a><a name="getInertEqs"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-3"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="getInertUnsolved"></a><span class='hs-definition'>getInertUnsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-comment'>-- Return (unsolved-wanteds, insolubles)</span>
<a name="line-7"></a><span class='hs-comment'>-- Both consist of a mixture of Wanted and Derived</span>
<a name="line-8"></a><span class='hs-definition'>getInertUnsolved</span>
<a name="line-9"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-10"></a>
<a name="line-11"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>icans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>is</span>
<a name="line-12"></a>            <span class='hs-varid'>unsolved_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>filterBag</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>
<a name="line-13"></a>            <span class='hs-varid'>unsolved_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractUnsolvedCMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>
<a name="line-14"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>unsolved_funeqs</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partCtFamHeadMap</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>
<a name="line-15"></a>            <span class='hs-varid'>unsolved_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a>            <span class='hs-varid'>unsolved_flats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsolved_eqs</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>unsolved_irreds</span> <span class='hs-varop'>`unionBags`</span> 
<a name="line-18"></a>                             <span class='hs-varid'>unsolved_dicts</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>unsolved_funeqs</span>
<a name="line-19"></a>
<a name="line-20"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsolved_flats</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>cts</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-varop'>`extendCts`</span> <span class='hs-varid'>ct</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Wanted or Derived</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="checkAllSolved"></a><span class='hs-definition'>checkAllSolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-29"></a><span class='hs-comment'>-- True if there are no unsolved wanteds</span>
<a name="line-30"></a><span class='hs-comment'>-- Ignore Derived for this purpose, unless in insolubles</span>
<a name="line-31"></a><span class='hs-definition'>checkAllSolved</span>
<a name="line-32"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-33"></a>
<a name="line-34"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>icans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>is</span>
<a name="line-35"></a>            <span class='hs-varid'>unsolved_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>anyBag</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>
<a name="line-36"></a>            <span class='hs-varid'>unsolved_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNullUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-37"></a>            <span class='hs-varid'>unsolved_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyFamHeadMap</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>
<a name="line-38"></a>            <span class='hs-varid'>unsolved_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isWantedCt</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsolved_eqs</span> <span class='hs-varop'>||</span> <span class='hs-varid'>unsolved_irreds</span>
<a name="line-41"></a>                     <span class='hs-varop'>||</span> <span class='hs-varid'>unsolved_dicts</span> <span class='hs-varop'>||</span> <span class='hs-varid'>unsolved_funeqs</span>
<a name="line-42"></a>                     <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_insols</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="extractRelevantInerts"></a><span class='hs-definition'>extractRelevantInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-45"></a><span class='hs-comment'>-- Returns the constraints from the inert set that are 'relevant' to react with </span>
<a name="line-46"></a><span class='hs-comment'>-- this constraint. The monad is left with the 'thinner' inerts. </span>
<a name="line-47"></a><span class='hs-comment'>-- NB: This function contains logic specific to the constraint solver, maybe move there?</span>
<a name="line-48"></a><span class='hs-definition'>extractRelevantInerts</span> <span class='hs-varid'>wi</span> 
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyInertTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_relevants</span> <span class='hs-varid'>wi</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyword'>where</span> 
<a name="line-51"></a>        <span class='hs-varid'>extract_relevants</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span><span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-52"></a>        <span class='hs-varid'>extract_relevants</span> <span class='hs-varid'>wi</span> <span class='hs-varid'>is</span> 
<a name="line-53"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extract_ics_relevants</span> <span class='hs-varid'>wi</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-54"></a>            <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-55"></a>            
<a name="line-56"></a>        <span class='hs-varid'>extract_ics_relevants</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-57"></a>        <span class='hs-varid'>extract_ics_relevants</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span><span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cl</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> 
<a name="line-58"></a>            <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-varid'>dict_map</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRelevantCts</span> <span class='hs-varid'>cl</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> 
<a name="line-59"></a>            <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dict_map</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a>        <span class='hs-varid'>extract_ics_relevants</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeq_map</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-62"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFamHead</span> <span class='hs-varid'>funeq_map</span> <span class='hs-varid'>fam_head</span>
<a name="line-63"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>singleCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFamHead</span> <span class='hs-varid'>funeq_map</span> <span class='hs-varid'>fam_head</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-64"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-65"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span>
<a name="line-66"></a>            <span class='hs-keyword'>where</span>
<a name="line-67"></a>              <span class='hs-varid'>fam_head</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_fun</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_tyargs</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-varid'>extract_ics_relevants</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ics</span>
<a name="line-70"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"extractRelevantInerts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wi</span><span class='hs-layout'>)</span>
<a name="line-71"></a>              <span class='hs-comment'>-- Holes are put straight into inert_frozen, so never get here</span>
<a name="line-72"></a>
<a name="line-73"></a>        <span class='hs-varid'>extract_ics_relevants</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> 
<a name="line-74"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span> 
<a name="line-75"></a>            <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a>        <span class='hs-varid'>extract_ics_relevants</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>,</span><span class='hs-varid'>ics</span><span class='hs-layout'>)</span>
<a name="line-78"></a>        
<a name="line-79"></a>
<a name="line-80"></a><a name="lookupFlatEqn"></a><span class='hs-definition'>lookupFlatEqn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-definition'>lookupFlatEqn</span> <span class='hs-varid'>fam_ty</span> 
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_funeqs</span>
<a name="line-83"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat_cache</span>
<a name="line-84"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-85"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupFamHead</span> <span class='hs-varid'>solved_funeqs</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varop'>`firstJust`</span> 
<a name="line-86"></a>                 <span class='hs-varid'>lookup_in_inerts</span> <span class='hs-varid'>inert_funeqs</span>    <span class='hs-varop'>`firstJust`</span>
<a name="line-87"></a>                 <span class='hs-varid'>lookupFamHead</span> <span class='hs-varid'>flat_cache</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-88"></a>  <span class='hs-keyword'>where</span>
<a name="line-89"></a>    <span class='hs-varid'>lookup_in_inerts</span> <span class='hs-varid'>inert_funeqs</span> 
<a name="line-90"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupFamHead</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>fam_ty</span> <span class='hs-keyword'>of</span>
<a name="line-91"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-92"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="lookupInInerts"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-95"></a><span class='hs-comment'>-- Is this exact predicate type cached in the solved or canonicals of the InertSet</span>
<a name="line-96"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-varid'>pty</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-98"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupSolvedDict</span> <span class='hs-varid'>inerts</span> <span class='hs-varid'>pty</span> <span class='hs-keyword'>of</span>
<a name="line-99"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-100"></a>           <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupInInertCans</span> <span class='hs-varid'>inerts</span> <span class='hs-varid'>pty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="lookupSolvedDict"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-103"></a><span class='hs-comment'>-- Returns just if exactly this predicate type exists in the solved.</span>
<a name="line-104"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>pty</span> 
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>pty</span> <span class='hs-layout'>(</span><span class='hs-varid'>unPredMap</span> <span class='hs-varid'>solved</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="lookupInInertCans"></a><span class='hs-definition'>lookupInInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-108"></a><span class='hs-comment'>-- Returns Just if exactly this pred type exists in the inert canonicals</span>
<a name="line-109"></a><span class='hs-definition'>lookupInInertCans</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>pty</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pty</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-111"></a>      <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-keyword'>_</span> 
<a name="line-112"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupCCanMap</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>pty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span>
<a name="line-113"></a>
<a name="line-114"></a>      <span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-sel'>_ty2</span> 
<a name="line-115"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty1</span>      <span class='hs-comment'>-- Tyvar equation</span>
<a name="line-116"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-117"></a>      	 <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-118"></a>      	 <span class='hs-layout'>,</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ctev</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>pty</span>
<a name="line-119"></a>      	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span>
<a name="line-120"></a>
<a name="line-121"></a>      	 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>  <span class='hs-comment'>-- Family equation</span>
<a name="line-122"></a>      	 <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>unFamHeadMap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span>
<a name="line-123"></a>      	 <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-124"></a>      	 <span class='hs-layout'>,</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ctev</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>pty</span>
<a name="line-125"></a>      	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span>
<a name="line-126"></a>
<a name="line-127"></a>      <span class='hs-conid'>IrredPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>findEvidence</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>pty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span>
<a name="line-128"></a>    
<a name="line-129"></a>      <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span> <span class='hs-comment'>-- NB: No caching for IPs or holes</span>
</pre>\end{code}




%************************************************************************
%*									*
%*		The TcS solver monad                                    *
%*									*
%************************************************************************

Note [The TcS monad]
~~~~~~~~~~~~~~~~~~~~
The TcS monad is a weak form of the main Tc monad

All you can do is
    * fail
    * allocate new variables
    * fill in evidence variables

Filling in a dictionary evidence variable means to create a binding
for it, so TcS carries a mutable location where the binding can be
added.  This is initialised from the innermost implication constraint.

\begin{code}
<pre><a name="line-1"></a><a name="TcSEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcSEnv</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> 
<a name="line-3"></a>      <span class='hs-varid'>tcs_ev_binds</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>,</span>
<a name="line-4"></a>      
<a name="line-5"></a>      <span class='hs-varid'>tcs_ty_binds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-6"></a>          <span class='hs-comment'>-- Global type bindings</span>
<a name="line-7"></a>                     
<a name="line-8"></a>      <span class='hs-varid'>tcs_count</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Global step count</span>
<a name="line-9"></a>
<a name="line-10"></a>      <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Current inert set</span>
<a name="line-11"></a>      <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Current worklist</span>
<a name="line-12"></a>      
<a name="line-13"></a>      <span class='hs-comment'>-- Residual implication constraints that are generated </span>
<a name="line-14"></a>      <span class='hs-comment'>-- while solving or canonicalising the current worklist.</span>
<a name="line-15"></a>      <span class='hs-comment'>-- Specifically, when canonicalising (forall a. t1 ~ forall a. t2)</span>
<a name="line-16"></a>      <span class='hs-comment'>-- from which we get the implication (forall a. t1 ~ t2)</span>
<a name="line-17"></a>      <span class='hs-varid'>tcs_implics</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span>
<a name="line-18"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="TcS"></a><span class='hs-comment'>---------------</span>
<a name="line-3"></a><a name="TcS"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span> 
<a name="line-4"></a>
<a name="line-5"></a><a name="instance%20Functor%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-6"></a>  <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="instance%20Monad%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span> 
<a name="line-9"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> 
<a name="line-10"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> 
<a name="line-11"></a>  <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ebs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ebs</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>ebs</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="wrapTcS"></a><span class='hs-comment'>-- Basic functionality </span>
<a name="line-14"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-15"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-16"></a><span class='hs-comment'>-- Do not export wrapTcS, because it promotes an arbitrary TcM to TcS,</span>
<a name="line-17"></a><span class='hs-comment'>-- and TcS is supposed to have limited functionality</span>
<a name="line-18"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span> <span class='hs-comment'>-- a TcM action will not use the TcEvBinds</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="wrapErrTcS"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-21"></a><span class='hs-comment'>-- The thing wrapped should just fail</span>
<a name="line-22"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-23"></a><span class='hs-comment'>-- Having a variant for each error message is too painful</span>
<a name="line-24"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="wrapWarnTcS"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-27"></a><span class='hs-comment'>-- The thing wrapped should just add a warning, or no-op</span>
<a name="line-28"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-29"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="failTcS"></a><span class='hs-definition'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>panicTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-32"></a><span class='hs-definition'>failTcS</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>failWith</span>
<a name="line-33"></a><a name="panicTcS"></a><span class='hs-definition'>panicTcS</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"TcCanonical"</span> <span class='hs-varid'>doc</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="traceTcS"></a><span class='hs-definition'>traceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-36"></a><span class='hs-definition'>traceTcS</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="instance%20HasDynFlags%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasDynFlags</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-39"></a>    <span class='hs-varid'>getDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="bumpStepCountTcS"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-42"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span>
<a name="line-43"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-44"></a>                                    <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="traceFireTcS"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-47"></a><span class='hs-comment'>-- Dump a rule-firing trace</span>
<a name="line-48"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>doc</span> 
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-50"></a>    <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>whenDOptM</span> <span class='hs-conid'>Opt_D_dump_cs_trace</span> <span class='hs-varop'>$</span> 
<a name="line-51"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-52"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_loc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpTcRn</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="runTcS"></a><span class='hs-definition'>runTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>		       <span class='hs-comment'>-- What to run</span>
<a name="line-56"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-definition'>runTcS</span> <span class='hs-varid'>tcs</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-59"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-60"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBinds</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-61"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="runTcSWithEvBinds"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-64"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-65"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-66"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-68"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>step_count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-num'>0</span>
<a name="line-69"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>is</span> 
<a name="line-70"></a>
<a name="line-71"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-72"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ty_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_binds_var</span>
<a name="line-73"></a>			  <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>step_count</span>
<a name="line-74"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_var</span>
<a name="line-75"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"runTcS: worklist"</span>
<a name="line-76"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_implics</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"runTcS: implics"</span> <span class='hs-layout'>}</span>
<a name="line-77"></a>                               <span class='hs-comment'>-- NB: Both these are initialised by withWorkList</span>
<a name="line-78"></a>
<a name="line-79"></a>	     <span class='hs-comment'>-- Run the computation</span>
<a name="line-80"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>env</span>
<a name="line-81"></a>	     <span class='hs-comment'>-- Perform the type unifications required</span>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ty_binds_var</span>
<a name="line-83"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>do_unification</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>ty_binds</span><span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-86"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>step_count</span>
<a name="line-87"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>count</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-88"></a>         <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>debugDumpTcRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Constraint solver steps ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>count</span> <span class='hs-layout'>)</span>
<a name="line-89"></a>
<a name="line-90"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBinds</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-91"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-92"></a><span class='hs-cpp'>#endif</span>
<a name="line-93"></a>
<a name="line-94"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-95"></a>  <span class='hs-keyword'>where</span>
<a name="line-96"></a>    <span class='hs-varid'>do_unification</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-97"></a>    <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInert</span>
<a name="line-98"></a>    
<a name="line-99"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-100"></a><a name="checkForCyclicBinds"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-101"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cycles</span> 
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-104"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-str'>"Cycle in evidence binds"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cycles</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Cycle in coercion bindings"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-108"></a>  <span class='hs-keyword'>where</span>
<a name="line-109"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvBind</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-110"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stronglyConnCompFromEdgedVertices</span> <span class='hs-varid'>edges</span><span class='hs-keyglyph'>]</span>
<a name="line-111"></a>
<a name="line-112"></a>    <span class='hs-varid'>coercion_cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cycles</span><span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_co_bind</span> <span class='hs-varid'>c</span><span class='hs-keyglyph'>]</span>
<a name="line-113"></a>    <span class='hs-varid'>is_co_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqVar</span> <span class='hs-varid'>b</span>
<a name="line-114"></a>
<a name="line-115"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-116"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>ev_binds</span><span class='hs-keyglyph'>]</span>
<a name="line-117"></a><span class='hs-cpp'>#endif       </span>
<a name="line-118"></a>
<a name="line-119"></a><a name="nestImplicTcS"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-120"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>inner_untch</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span> 
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ty_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_binds</span>
<a name="line-122"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-123"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>inerts</span>
<a name="line-124"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span>
<a name="line-125"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ty_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_binds</span>
<a name="line-126"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-127"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-128"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"nextImplicTcS: worklist"</span>
<a name="line-129"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_implics</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"nextImplicTcS: implics"</span>
<a name="line-130"></a>                               <span class='hs-comment'>-- NB: Both these are initialised by withWorkList</span>
<a name="line-131"></a>                               <span class='hs-layout'>}</span>
<a name="line-132"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>setUntouchables</span> <span class='hs-varid'>inner_untch</span> <span class='hs-varop'>$</span>
<a name="line-133"></a>                <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span>
<a name="line-134"></a>                
<a name="line-135"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-136"></a>       <span class='hs-comment'>-- Perform a check that the thing_inside did not cause cycles</span>
<a name="line-137"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBinds</span> <span class='hs-varid'>ref</span>
<a name="line-138"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-139"></a><span class='hs-cpp'>#endif</span>
<a name="line-140"></a>         
<a name="line-141"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="recoverTcS"></a><span class='hs-definition'>recoverTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-144"></a><span class='hs-definition'>recoverTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>recovery_code</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-146"></a>    <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>recoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>recovery_code</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="nestTcS"></a><span class='hs-definition'>nestTcS</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-149"></a><span class='hs-comment'>-- Use the current untouchables, augmenting the current</span>
<a name="line-150"></a><span class='hs-comment'>-- evidence bindings, ty_binds, and solved caches</span>
<a name="line-151"></a><span class='hs-comment'>-- But have no effect on the InertCans or insolubles</span>
<a name="line-152"></a><span class='hs-definition'>nestTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span> 
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts_var</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-154"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>inerts_var</span>
<a name="line-155"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>inerts</span>
<a name="line-156"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-157"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"nextImplicTcS: worklist"</span>
<a name="line-158"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_implics</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"nextImplicTcS: implics"</span> <span class='hs-layout'>}</span>
<a name="line-159"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span> <span class='hs-layout'>}</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="tryTcS"></a><span class='hs-definition'>tryTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-162"></a><span class='hs-comment'>-- Like runTcS, but from within the TcS monad </span>
<a name="line-163"></a><span class='hs-comment'>-- Completely afresh inerts and worklist, be careful! </span>
<a name="line-164"></a><span class='hs-comment'>-- Moreover, we will simply throw away all the evidence generated. </span>
<a name="line-165"></a><span class='hs-definition'>tryTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-167"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyInert</span>
<a name="line-168"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-169"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-170"></a>
<a name="line-171"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-172"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ty_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_binds_var</span>
<a name="line-173"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_var</span>
<a name="line-174"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"nextImplicTcS: worklist"</span>
<a name="line-175"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_implics</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"nextImplicTcS: implics"</span> <span class='hs-layout'>}</span>
<a name="line-176"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span> <span class='hs-layout'>}</span>
<a name="line-177"></a>
<a name="line-178"></a><span class='hs-comment'>-- Getters and setters of TcEnv fields</span>
<a name="line-179"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-180"></a>
<a name="line-181"></a><a name="getTcSInertsRef"></a><span class='hs-comment'>-- Getter of inerts and worklist</span>
<a name="line-182"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-183"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_inerts</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="getTcSWorkListRef"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span> 
<a name="line-186"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_worklist</span><span class='hs-layout'>)</span> 
<a name="line-187"></a>
<a name="line-188"></a><a name="getTcSInerts"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertSet</span> 
<a name="line-189"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTcSInertsRef</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span><span class='hs-layout'>)</span> 
<a name="line-190"></a>
<a name="line-191"></a><a name="updWorkListTcS"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-192"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-varid'>f</span> 
<a name="line-193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-194"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-195"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_work</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>wl_curr</span>
<a name="line-196"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>new_work</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-197"></a>
<a name="line-198"></a><a name="updWorkListTcS_return"></a><span class='hs-definition'>updWorkListTcS_return</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-199"></a><span class='hs-comment'>-- Process the work list, returning a depleted work list,</span>
<a name="line-200"></a><span class='hs-comment'>-- plus a value extracted from it (typically a work item removed from it)</span>
<a name="line-201"></a><span class='hs-definition'>updWorkListTcS_return</span> <span class='hs-varid'>f</span>
<a name="line-202"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-203"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-204"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span><span class='hs-varid'>new_work</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>wl_curr</span>
<a name="line-205"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>new_work</span><span class='hs-layout'>)</span>
<a name="line-206"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-207"></a>
<a name="line-208"></a><a name="withWorkList"></a><span class='hs-definition'>withWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span>
<a name="line-209"></a><span class='hs-comment'>-- Use 'thing_inside' to solve 'work_items', extending the</span>
<a name="line-210"></a><span class='hs-comment'>-- ambient InertSet, and returning any residual implications</span>
<a name="line-211"></a><span class='hs-comment'>-- (arising from polytype equalities)</span>
<a name="line-212"></a><span class='hs-comment'>-- We do this with fresh work list and residual-implications variables</span>
<a name="line-213"></a><span class='hs-definition'>withWorkList</span> <span class='hs-varid'>work_items</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-214"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tcs_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-215"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>init_work_list</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>extendWorkListCt</span> <span class='hs-varid'>emptyWorkList</span> <span class='hs-varid'>work_items</span>
<a name="line-216"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>init_work_list</span>
<a name="line-217"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_implics_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyBag</span>
<a name="line-218"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span>
<a name="line-219"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_implics_var</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-220"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>final_wl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>new_wl_var</span>
<a name="line-221"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>implics</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>new_implics_var</span>
<a name="line-222"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isEmptyWorkList</span> <span class='hs-varid'>final_wl</span> <span class='hs-layout'>)</span>
<a name="line-223"></a>         <span class='hs-varid'>return</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span>
<a name="line-224"></a>
<a name="line-225"></a><a name="updTcSImplics"></a><span class='hs-definition'>updTcSImplics</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-226"></a><span class='hs-definition'>updTcSImplics</span> <span class='hs-varid'>f</span> 
<a name="line-227"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>impl_ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSImplicsRef</span>
<a name="line-228"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>implics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>impl_ref</span>
<a name="line-229"></a>                     <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>impl_ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-230"></a>
<a name="line-231"></a><a name="emitInsoluble"></a><span class='hs-definition'>emitInsoluble</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-232"></a><span class='hs-comment'>-- Emits a non-canonical constraint that will stand for a frozen error in the inerts. </span>
<a name="line-233"></a><span class='hs-definition'>emitInsoluble</span> <span class='hs-varid'>ct</span>
<a name="line-234"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emit insoluble"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-235"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varid'>add_insol</span> <span class='hs-layout'>}</span>
<a name="line-236"></a>  <span class='hs-keyword'>where</span>
<a name="line-237"></a>    <span class='hs-varid'>this_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span>
<a name="line-238"></a>    <span class='hs-varid'>add_insol</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_insols</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-239"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>already_there</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span>
<a name="line-240"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCts</span> <span class='hs-varid'>old_insols</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-241"></a>      <span class='hs-keyword'>where</span>
<a name="line-242"></a>        <span class='hs-varid'>already_there</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>anyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqType</span> <span class='hs-varid'>this_pred</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctPred</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_insols</span>
<a name="line-243"></a>	     <span class='hs-comment'>-- See Note [Do not add duplicate derived insolubles]</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="getTcSImplicsRef"></a><span class='hs-definition'>getTcSImplicsRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-246"></a><span class='hs-definition'>getTcSImplicsRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_implics</span><span class='hs-layout'>)</span> 
<a name="line-247"></a>
<a name="line-248"></a><a name="getTcEvBinds"></a><span class='hs-definition'>getTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-249"></a><span class='hs-definition'>getTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_ev_binds</span><span class='hs-layout'>)</span> 
<a name="line-250"></a>
<a name="line-251"></a><a name="getUntouchables"></a><span class='hs-definition'>getUntouchables</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Untouchables</span>
<a name="line-252"></a><span class='hs-definition'>getUntouchables</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getUntouchables</span>
<a name="line-253"></a>
<a name="line-254"></a><a name="getFlattenSkols"></a><span class='hs-definition'>getFlattenSkols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-255"></a><span class='hs-definition'>getFlattenSkols</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_fsks</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-256"></a>
<a name="line-257"></a><a name="getTcSTyBinds"></a><span class='hs-definition'>getTcSTyBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-258"></a><span class='hs-definition'>getTcSTyBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_ty_binds</span><span class='hs-layout'>)</span>
<a name="line-259"></a>
<a name="line-260"></a><a name="getTcSTyBindsMap"></a><span class='hs-definition'>getTcSTyBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-261"></a><span class='hs-definition'>getTcSTyBindsMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTcSTyBinds</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span><span class='hs-layout'>)</span> 
<a name="line-262"></a>
<a name="line-263"></a><a name="getTcEvBindsMap"></a><span class='hs-definition'>getTcEvBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-264"></a><span class='hs-definition'>getTcEvBindsMap</span>
<a name="line-265"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-varid'>ev_ref</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBinds</span> 
<a name="line-266"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ev_ref</span> <span class='hs-layout'>}</span>
<a name="line-267"></a>
<a name="line-268"></a><a name="setWantedTyBind"></a><span class='hs-definition'>setWantedTyBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-269"></a><span class='hs-comment'>-- Add a type binding</span>
<a name="line-270"></a><span class='hs-comment'>-- We never do this twice!</span>
<a name="line-271"></a><span class='hs-definition'>setWantedTyBind</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> 
<a name="line-272"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-273"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSTyBinds</span>
<a name="line-274"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> 
<a name="line-275"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-276"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>$</span>
<a name="line-277"></a>                  <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>checkErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>ty_binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-278"></a>                  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TERRIBLE ERROR: double set of meta type variable"</span>
<a name="line-279"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-280"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Old value ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupVarEnv_NF</span> <span class='hs-varid'>ty_binds</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-281"></a>            <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-str'>"setWantedTyBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-282"></a>            <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>ty_binds</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="getDefaultInfo"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetDefaultTys</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-- Just get some environments needed for instance looking up and matching</span>
<a name="line-5"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="getInstEnvs"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstEnv</span><span class='hs-layout'>)</span> 
<a name="line-8"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Inst</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetInstEnvs</span> 
<a name="line-9"></a>
<a name="line-10"></a><a name="getFamInstEnvs"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span> 
<a name="line-11"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FamInst</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="getTopEnv"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>HscEnv</span> 
<a name="line-14"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTopEnv</span> 
<a name="line-15"></a>
<a name="line-16"></a><a name="getGblEnv"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcGblEnv</span> 
<a name="line-17"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getGblEnv</span> 
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-comment'>-- Various smaller utilities [TODO, maybe will be absorbed in the instance matcher]</span>
<a name="line-20"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="checkWellStagedDFun"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-23"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>loc</span> 
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> 
<a name="line-25"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>use_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getStage</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>checkWellStaged</span> <span class='hs-varid'>pp_thing</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>thLevel</span> <span class='hs-varid'>use_stage</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>  <span class='hs-keyword'>where</span>
<a name="line-28"></a>    <span class='hs-varid'>pp_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"instance for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-29"></a>    <span class='hs-varid'>bind_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>topIdLvl</span> <span class='hs-varid'>dfun_id</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="pprEq"></a><span class='hs-definition'>pprEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-32"></a><span class='hs-definition'>pprEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprType</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkEqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="isTouchableMetaTyVarTcS"></a><span class='hs-definition'>isTouchableMetaTyVarTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-35"></a><span class='hs-definition'>isTouchableMetaTyVarTcS</span> <span class='hs-varid'>tv</span> 
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>untch</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUntouchables</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isTouchableMetaTyVar</span> <span class='hs-varid'>untch</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span> 
<a name="line-38"></a>
<a name="line-39"></a><a name="isFilledMetaTyVar_maybe"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-varid'>tv</span>
<a name="line-41"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-42"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-43"></a>     <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span> 
<a name="line-44"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-45"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span> 
<a name="line-46"></a>                  <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-47"></a>                  <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-48"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> 
<a name="line-49"></a>
<a name="line-50"></a><a name="zonkTyVarsAndFV"></a><span class='hs-definition'>zonkTyVarsAndFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-51"></a><span class='hs-definition'>zonkTyVarsAndFV</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTyVarsAndFV</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Do not add duplicate derived insolubles]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general we *must* add an insoluble (Int ~ Bool) even if there is
one such there already, because they may come from distinct call
sites.  Not only do we want an error message for each, but with
-fdefer-type-errors we must generate evidence for each.  But for
*derived* insolubles, we only want to report each one once.  Why?

(a) A constraint (C r s t) where r -> s, say, may generate the same fundep
    equality many times, as the original constraint is sucessively rewritten.

(b) Ditto the successive iterations of the main solver itself, as it traverses
    the constraint tree. See example below.

Also for *given* insolubles we may get repeated errors, as we
repeatedly traverse the constraint tree.  These are relatively rare
anyway, so removing duplicates seems ok.  (Alternatively we could take
the SrcLoc into account.)

Note that the test does not need to be particularly efficient because
it is only used if the program has a type error anyway.

Example of (b): assume a top-level class and instance declaration:

  class D a b | a -> b 
  instance D [a] [a] 

Assume we have started with an implication:

  forall c. Eq c => { wc_flat = D [c] c [W] }

which we have simplified to:

  forall c. Eq c => { wc_flat = D [c] c [W]
                    , wc_insols = (c ~ [c]) [D] }

For some reason, e.g. because we floated an equality somewhere else,
we might try to re-solve this implication. If we do not do a
dropDerivedWC, then we will end up trying to solve the following
constraints the second time:

  (D [c] c) [W]
  (c ~ [c]) [D]

which will result in two Deriveds to end up in the insoluble set:

  wc_flat   = D [c] c [W]
  wc_insols = (c ~ [c]) [D], (c ~ [c]) [D]



\begin{code}
<pre><a name="line-1"></a><a name="newFlattenSkolem"></a><span class='hs-comment'>-- Flatten skolems</span>
<a name="line-2"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavour</span> 
<a name="line-4"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>                      <span class='hs-comment'>-- F xis</span>
<a name="line-5"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- co :: F xis ~ ty</span>
<a name="line-6"></a><span class='hs-comment'>-- We have already looked up in the cache; no need to so so again</span>
<a name="line-7"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-conid'>Given</span> <span class='hs-varid'>fam_ty</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> 
<a name="line-9"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newUnique</span>
<a name="line-10"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>mkTcTyVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"f"</span><span class='hs-layout'>)</span>
<a name="line-11"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlatSkol</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> 
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"New Flatten Skolem Born"</span> <span class='hs-varop'>$</span>
<a name="line-13"></a>         <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[:= "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"]"</span>
<a name="line-14"></a>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span>
<a name="line-16"></a>             <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcEqPred</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-17"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_fsks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsks</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-20"></a>            <span class='hs-varid'>extendFlatCache</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varid'>ctev</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-21"></a>            <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_fsks</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fsks</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fam_ty</span>  <span class='hs-comment'>-- Wanted or Derived: make new unification variable</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTcSTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcEqPred</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span>
<a name="line-28"></a>                                   <span class='hs-comment'>-- NC (no-cache) version because we've already</span>
<a name="line-29"></a>                                   <span class='hs-comment'>-- looked in the solved goals an inerts (lookupFlatEqn)</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extendFlatCache</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varid'>ctev</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="extendFlatCache"></a><span class='hs-definition'>extendFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-35"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span>
<a name="line-36"></a><span class='hs-definition'>extendFlatCache</span> <span class='hs-varid'>dflags</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_FlatCache</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>is</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varid'>ctev</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-41"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertFamHead</span> <span class='hs-varid'>fc</span> <span class='hs-varid'>fam_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-comment'>-- Instantiations </span>
<a name="line-44"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="instDFunType"></a><span class='hs-definition'>instDFunType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DFunInstType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-definition'>instDFunType</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>mb_inst_tys</span> 
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>dfun_tvs</span> <span class='hs-varid'>mb_inst_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyword'>where</span>
<a name="line-50"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>dfun_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfun_phi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dfun_id</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DFunInstType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-53"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>dfun_phi</span><span class='hs-layout'>)</span>
<a name="line-54"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mb_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-55"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>mb_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-56"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-57"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mb_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-58"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instFlexiTcSHelper</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-59"></a>                         <span class='hs-comment'>-- Don't forget to instantiate the kind!</span>
<a name="line-60"></a>                         <span class='hs-comment'>-- cf TcMType.tcInstTyVarX</span>
<a name="line-61"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>mb_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-62"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"instDFunTypes"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mb_inst_tys</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="newFlexiTcSTy"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>  
<a name="line-66"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-varid'>knd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>knd</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="cloneMetaTyVar"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-69"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="instFlexiTcS"></a><span class='hs-definition'>instFlexiTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-definition'>instFlexiTcS</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>inst_one</span> <span class='hs-varid'>emptyTvSubst</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyword'>where</span>
<a name="line-74"></a>     <span class='hs-varid'>inst_one</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> 
<a name="line-75"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instFlexiTcSHelper</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> 
<a name="line-76"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-77"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="instFlexiTcSHelper"></a><span class='hs-definition'>instFlexiTcSHelper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-80"></a><span class='hs-definition'>instFlexiTcSHelper</span> <span class='hs-varid'>tvname</span> <span class='hs-varid'>kind</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newUnique</span> 
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newMetaDetails</span> <span class='hs-conid'>TauTv</span>
<a name="line-83"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-varid'>tvname</span> <span class='hs-varid'>uniq</span> 
<a name="line-84"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="instFlexiTcSHelperTcS"></a><span class='hs-definition'>instFlexiTcSHelperTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-87"></a><span class='hs-definition'>instFlexiTcSHelperTcS</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>instFlexiTcSHelper</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-comment'>-- Creating and setting evidence variables and CtFlavors</span>
<a name="line-91"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="XEvTerm"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>XEvTerm</span> <span class='hs-keyglyph'>=</span> 
<a name="line-94"></a>  <span class='hs-conid'>XEvTerm</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_comp</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-95"></a>                         <span class='hs-comment'>-- How to compose evidence </span>
<a name="line-96"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ev_decomp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span>
<a name="line-97"></a>                         <span class='hs-comment'>-- How to decompose evidence </span>
<a name="line-98"></a>          <span class='hs-layout'>}</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="MaybeNew"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fresh</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Cached</span> <span class='hs-conid'>EvTerm</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="isFresh"></a><span class='hs-definition'>isFresh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-103"></a><span class='hs-definition'>isFresh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-104"></a><span class='hs-definition'>isFresh</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="getEvTerm"></a><span class='hs-definition'>getEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-107"></a><span class='hs-definition'>getEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvTerm</span> <span class='hs-varid'>ctev</span>
<a name="line-108"></a><span class='hs-definition'>getEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cached</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="getEvTerms"></a><span class='hs-definition'>getEvTerms</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeNew</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span>
<a name="line-111"></a><span class='hs-definition'>getEvTerms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getEvTerm</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="freshGoals"></a><span class='hs-definition'>freshGoals</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeNew</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-114"></a><span class='hs-definition'>freshGoals</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>]</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="setEvBind"></a><span class='hs-definition'>setEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-117"></a><span class='hs-definition'>setEvBind</span> <span class='hs-varid'>the_ev</span> <span class='hs-varid'>tm</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"setEvBind"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ev ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>the_ev</span>
<a name="line-119"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tm  ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>]</span>
<a name="line-120"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_evbinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBinds</span>
<a name="line-121"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addTcEvBind</span> <span class='hs-varid'>tc_evbinds</span> <span class='hs-varid'>the_ev</span> <span class='hs-varid'>tm</span> <span class='hs-layout'>}</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="newGivenEvVar"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-124"></a><span class='hs-comment'>-- Make a new variable of the given PredType, </span>
<a name="line-125"></a><span class='hs-comment'>-- immediately bind it to the given term</span>
<a name="line-126"></a><span class='hs-comment'>-- and return its CtEvidence</span>
<a name="line-127"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>rhs</span>
<a name="line-128"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pred</span>
<a name="line-129"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>new_ev</span> <span class='hs-varid'>rhs</span>
<a name="line-130"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-varid'>new_ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="newWantedEvVarNC"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-133"></a><span class='hs-comment'>-- Don't look up in the solved/inerts; we know it's not there</span>
<a name="line-134"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-varid'>pty</span>
<a name="line-135"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pty</span>
<a name="line-136"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-137"></a>
<a name="line-138"></a><a name="newWantedEvVar"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>MaybeNew</span>
<a name="line-139"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-varid'>pty</span>
<a name="line-140"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInInerts</span> <span class='hs-varid'>pty</span>
<a name="line-141"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyword'>of</span>
<a name="line-142"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDerived</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> 
<a name="line-143"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newWantedEvVar/cache hit"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span>
<a name="line-144"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cached</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvTerm</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-145"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-varid'>pty</span>
<a name="line-146"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newWantedEvVar/cache miss"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span>
<a name="line-147"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="newDerived"></a><span class='hs-definition'>newDerived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-150"></a><span class='hs-comment'>-- Returns Nothing    if cached, </span>
<a name="line-151"></a><span class='hs-comment'>--         Just pred  if not cached</span>
<a name="line-152"></a><span class='hs-definition'>newDerived</span> <span class='hs-varid'>pty</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInInerts</span> <span class='hs-varid'>pty</span>
<a name="line-154"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyword'>of</span>
<a name="line-155"></a>                    <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-156"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="instDFunConstraints"></a><span class='hs-definition'>instDFunConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeNew</span><span class='hs-keyglyph'>]</span>
<a name="line-159"></a><span class='hs-definition'>instDFunConstraints</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newWantedEvVar</span>
</pre>\end{code}
                

Note [xCFlavor]
~~~~~~~~~~~~~~~
A call might look like this:

    xCtFlavor ev subgoal-preds evidence-transformer

  ev is Given   => use ev_decomp to create new Givens for subgoal-preds, 
                   and return them

  ev is Wanted  => create new wanteds for subgoal-preds, 
                   use ev_comp to bind ev, 
                   return fresh wanteds (ie ones not cached in inert_cans or solved)

  ev is Derived => create new deriveds for subgoal-preds 
                      (unless cached in inert_cans or solved)

Note: The [CtEvidence] returned is a subset of the subgoal-preds passed in
      Ones that are already cached are not returned

Example
    ev : Tree a b ~ Tree c d
    xCtFlavor ev [a~c, b~d] (XEvTerm { ev_comp = \[c1 c2]. <Tree> c1 c2
                                     , ev_decomp = \c. [nth 1 c, nth 2 c] })
              (\fresh-goals.  stuff)

Note [Bind new Givens immediately]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For Givens we make new EvVars and bind them immediately. We don't worry
about caching, but we don't expect complicated calculations among Givens.
It is important to bind each given:
      class (a~b) => C a b where ....
      f :: C a b => ....
Then in f's Givens we have g:(C a b) and the superclass sc(g,0):a~b.
But that superclass selector can't (yet) appear in a coercion
(see evTermCoercion), so the easy thing is to bind it to an Id.

See Note [Coercion evidence terms] in TcEvidence.


\begin{code}
<pre><a name="line-1"></a><a name="xCtFlavor"></a><span class='hs-definition'>xCtFlavor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span>            <span class='hs-comment'>-- Original flavor   </span>
<a name="line-2"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcPredType</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- New predicate types</span>
<a name="line-3"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>XEvTerm</span>               <span class='hs-comment'>-- Instructions about how to manipulate evidence</span>
<a name="line-4"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>xCtFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ptys</span> <span class='hs-varid'>xev</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>ptys</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_decomp</span> <span class='hs-varid'>xev</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-8"></a>    <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>ptys</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_decomp</span> <span class='hs-varid'>xev</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-9"></a>    <span class='hs-comment'>-- See Note [Bind new Givens immediately]</span>
<a name="line-10"></a>  
<a name="line-11"></a><span class='hs-definition'>xCtFlavor</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evar</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ptys</span> <span class='hs-varid'>xev</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_evars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>ptys</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>evar</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_comp</span> <span class='hs-varid'>xev</span> <span class='hs-layout'>(</span><span class='hs-varid'>getEvTerms</span> <span class='hs-varid'>new_evars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>freshGoals</span> <span class='hs-varid'>new_evars</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>    
<a name="line-16"></a><span class='hs-definition'>xCtFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ptys</span> <span class='hs-sel'>_xev</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ders</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newDerived</span> <span class='hs-varid'>ptys</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>catMaybes</span> <span class='hs-varid'>ders</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="rewriteCtFlavor"></a><span class='hs-comment'>-----------------------------</span>
<a name="line-21"></a><span class='hs-definition'>rewriteCtFlavor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-22"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span>   <span class='hs-comment'>-- new predicate</span>
<a name="line-23"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>   <span class='hs-comment'>-- new ~ old     </span>
<a name="line-24"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-comment'>-- Returns Just new_fl iff either (i)  'co' is reflexivity</span>
<a name="line-26"></a><span class='hs-comment'>--                             or (ii) 'co' is not reflexivity, and 'new_pred' not cached</span>
<a name="line-27"></a><span class='hs-comment'>-- In either case, there is nothing new to do with new_fl</span>
<a name="line-28"></a><span class='hs-comment'>{- 
<a name="line-29"></a>     rewriteCtFlavor old_fl new_pred co
<a name="line-30"></a>Main purpose: create new evidence for new_pred;
<a name="line-31"></a>              unless new_pred is cached already
<a name="line-32"></a>* Returns a new_fl : new_pred, with same wanted/given/derived flag as old_fl
<a name="line-33"></a>* If old_fl was wanted, create a binding for old_fl, in terms of new_fl
<a name="line-34"></a>* If old_fl was given, AND not cached, create a binding for new_fl, in terms of old_fl
<a name="line-35"></a>* Returns Nothing if new_fl is already cached
<a name="line-36"></a>
<a name="line-37"></a>
<a name="line-38"></a>        Old evidence    New predicate is               Return new evidence
<a name="line-39"></a>        flavour                                        of same flavor
<a name="line-40"></a>        -------------------------------------------------------------------
<a name="line-41"></a>        Wanted          Already solved or in inert     Nothing
<a name="line-42"></a>        or Derived      Not                            Just new_evidence
<a name="line-43"></a>
<a name="line-44"></a>        Given           Already in inert               Nothing
<a name="line-45"></a>                        Not                            Just new_evidence
<a name="line-46"></a>-}</span>
<a name="line-47"></a>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>rewriteCtFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_pred</span> <span class='hs-sel'>_co</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- If derived, don't even look at the coercion.</span>
<a name="line-51"></a>    <span class='hs-comment'>-- This is very important, DO NOT re-order the equations for</span>
<a name="line-52"></a>    <span class='hs-comment'>-- rewriteCtFlavor to put the isTcReflCo test first!  </span>
<a name="line-53"></a>    <span class='hs-comment'>-- Why?  Because for *Derived* constraints, c, the coercion, which </span>
<a name="line-54"></a>    <span class='hs-comment'>-- was produced by flattening, may contain suspended calls to </span>
<a name="line-55"></a>    <span class='hs-comment'>-- (ctEvTerm c), which fails for Derived constraints.</span>
<a name="line-56"></a>    <span class='hs-comment'>-- (Getting this wrong caused Trac #7384.)</span>
<a name="line-57"></a>    <span class='hs-varid'>newDerived</span> <span class='hs-varid'>new_pred</span>
<a name="line-58"></a>        
<a name="line-59"></a><span class='hs-definition'>rewriteCtFlavor</span> <span class='hs-varid'>old_ev</span> <span class='hs-varid'>new_pred</span> <span class='hs-varid'>co</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co</span> <span class='hs-comment'>-- If just reflexivity then you may re-use the same variable</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>old_ev</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>new_pred</span>
<a name="line-62"></a>                  <span class='hs-keyword'>then</span> <span class='hs-varid'>old_ev</span>
<a name="line-63"></a>                  <span class='hs-keyword'>else</span> <span class='hs-varid'>old_ev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_pred</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-64"></a>       <span class='hs-comment'>-- Even if the coercion is Refl, it might reflect the result of unification alpha := ty</span>
<a name="line-65"></a>       <span class='hs-comment'>-- so old_pred and new_pred might not *look* the same, and it's vital to proceed from</span>
<a name="line-66"></a>       <span class='hs-comment'>-- now on using new_pred.</span>
<a name="line-67"></a>       <span class='hs-comment'>-- However, if they *do* look the same, we'd prefer to stick with old_pred</span>
<a name="line-68"></a>       <span class='hs-comment'>-- then retain the old type, so that error messages come out mentioning synonyms</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-definition'>rewriteCtFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_tm</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_pred</span> <span class='hs-varid'>co</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>new_pred</span> <span class='hs-varid'>new_tm</span>  <span class='hs-comment'>-- See Note [Bind new Givens immediately]</span>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>new_ev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-73"></a>  <span class='hs-keyword'>where</span>
<a name="line-74"></a>    <span class='hs-varid'>new_tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEvCast</span> <span class='hs-varid'>old_tm</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- mkEvCast optimises ReflCo</span>
<a name="line-75"></a>  
<a name="line-76"></a><span class='hs-definition'>rewriteCtFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evar</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_pred</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_pred</span> <span class='hs-varid'>co</span>
<a name="line-77"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_evar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>new_pred</span>
<a name="line-78"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>evar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEvCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>getEvTerm</span> <span class='hs-varid'>new_evar</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-79"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>new_evar</span> <span class='hs-keyword'>of</span>
<a name="line-80"></a>            <span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> 
<a name="line-81"></a>            <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-82"></a>
<a name="line-83"></a>
<a name="line-84"></a>
<a name="line-85"></a><a name="matchOpenFam"></a><span class='hs-definition'>matchOpenFam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FamInstMatch</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-definition'>matchOpenFam</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcLookupFamInst</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="matchFam"></a><span class='hs-definition'>matchFam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-89"></a><span class='hs-definition'>matchFam</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenSynFamilyTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>maybe_match</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchOpenFam</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-92"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_match</span> <span class='hs-keyword'>of</span>
<a name="line-93"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-94"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstMatch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fim_instance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInst</span>
<a name="line-95"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>fim_tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-96"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcUnbranchedAxInstCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>famInstAxiom</span> <span class='hs-varid'>famInst</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_tys</span>
<a name="line-97"></a>                    <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pSnd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcCoercionKind</span> <span class='hs-varid'>co</span>
<a name="line-98"></a>                <span class='hs-keyword'>in</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-99"></a>
<a name="line-100"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isClosedSynFamilyTyCon_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-101"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>chooseBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>args</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcAxInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>inst_tys</span>
<a name="line-103"></a>        <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcCoercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-104"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-105"></a>
<a name="line-106"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-108"></a>       
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- Deferring forall equalities as implications</span>
<a name="line-2"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="deferTcSForAllEq"></a><span class='hs-definition'>deferTcSForAllEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span><span class='hs-layout'>,</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Original wanted equality flavor</span>
<a name="line-5"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ForAll tvs1 body1</span>
<a name="line-6"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ForAll tvs2 body2</span>
<a name="line-7"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-8"></a><span class='hs-comment'>-- Some of this functionality is repeated from TcUnify, </span>
<a name="line-9"></a><span class='hs-comment'>-- consider having a single place where we create fresh implications. </span>
<a name="line-10"></a><span class='hs-definition'>deferTcSForAllEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span><span class='hs-varid'>orig_ev</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span><span class='hs-varid'>body1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs2</span><span class='hs-layout'>,</span><span class='hs-varid'>body2</span><span class='hs-layout'>)</span>
<a name="line-11"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst1</span><span class='hs-layout'>,</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcInstSkolTyVars</span> <span class='hs-varid'>tvs1</span>
<a name="line-12"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-13"></a>            <span class='hs-varid'>phi1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst1</span> <span class='hs-varid'>body1</span>
<a name="line-14"></a>            <span class='hs-varid'>phi2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTopTvSubst</span> <span class='hs-varid'>tvs2</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>body2</span>
<a name="line-15"></a>            <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnifyForAllSkol</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>phi1</span>
<a name="line-16"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcEqPred</span> <span class='hs-varid'>phi1</span> <span class='hs-varid'>phi2</span><span class='hs-layout'>)</span>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>coe_inside</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mev</span> <span class='hs-keyword'>of</span>
<a name="line-18"></a>            <span class='hs-conid'>Cached</span> <span class='hs-varid'>ev_tm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>evTermCoercion</span> <span class='hs-varid'>ev_tm</span><span class='hs-layout'>)</span>
<a name="line-19"></a>            <span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-20"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getLclEnv</span>
<a name="line-21"></a>                               <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-22"></a>                                     <span class='hs-varid'>new_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ctev</span>
<a name="line-23"></a>              			     <span class='hs-varid'>new_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evTermCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvTerm</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-24"></a>                                     <span class='hs-varid'>new_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pushUntouchables</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_untch</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-25"></a>                               <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singleCt</span> <span class='hs-varid'>new_ct</span> 
<a name="line-26"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-27"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>                                     <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_untch</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_untch</span>
<a name="line-29"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-30"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_fsks</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-31"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-32"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> 
<a name="line-33"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-34"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-35"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-36"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>updTcSImplics</span> <span class='hs-layout'>(</span><span class='hs-varid'>consBag</span> <span class='hs-varid'>imp</span><span class='hs-layout'>)</span> 
<a name="line-38"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-varid'>ev_binds</span> <span class='hs-varid'>new_co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>orig_ev</span> <span class='hs-varop'>$</span>
<a name="line-41"></a>          <span class='hs-conid'>EvCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>mkTcForAllCo</span> <span class='hs-varid'>coe_inside</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span>
<a name="line-42"></a>        <span class='hs-layout'>}</span>
</pre>\end{code}

</body>
</html>
