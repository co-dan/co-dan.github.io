<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>basicTypes/Demand.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[Demand]{@Demand@: A decoupled implementation of a demand domain}

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Demand</span> <span class='hs-layout'>(</span>
<a name="line-3"></a>        <span class='hs-conid'>StrDmd</span><span class='hs-layout'>,</span> <span class='hs-conid'>UseDmd</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Count</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-4"></a>        <span class='hs-varid'>countOnce</span><span class='hs-layout'>,</span> <span class='hs-varid'>countMany</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- cardinality</span>
<a name="line-5"></a>
<a name="line-6"></a>        <span class='hs-conid'>Demand</span><span class='hs-layout'>,</span> <span class='hs-conid'>CleanDemand</span><span class='hs-layout'>,</span> 
<a name="line-7"></a>        <span class='hs-varid'>mkProdDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkOnceUsedDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkManyUsedDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHeadStrict</span><span class='hs-layout'>,</span> <span class='hs-varid'>oneifyDmd</span><span class='hs-layout'>,</span>
<a name="line-8"></a>        <span class='hs-varid'>getUsage</span><span class='hs-layout'>,</span> <span class='hs-varid'>toCleanDmd</span><span class='hs-layout'>,</span> 
<a name="line-9"></a>        <span class='hs-varid'>absDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>topDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDmd</span><span class='hs-layout'>,</span>
<a name="line-10"></a>        <span class='hs-varid'>lubDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>bothDmd</span><span class='hs-layout'>,</span>
<a name="line-11"></a>        <span class='hs-varid'>isTopDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBotDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isAbsDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSeqDmd</span><span class='hs-layout'>,</span> 
<a name="line-12"></a>        <span class='hs-varid'>peelUseCall</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanUseDmd_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>strictenDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>bothCleanDmd</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-conid'>DmdType</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdTypeDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>lubDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>bothDmdEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>bothDmdType</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>topDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTopDmdType</span><span class='hs-layout'>,</span> 
<a name="line-16"></a>
<a name="line-17"></a>        <span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDmdEnv</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-conid'>DmdResult</span><span class='hs-layout'>,</span> <span class='hs-conid'>CPRResult</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>isBotRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTopRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>resTypeArgDmd</span><span class='hs-layout'>,</span> 
<a name="line-21"></a>        <span class='hs-varid'>topRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>botRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>cprProdRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>cprSumRes</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>appIsBottom</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBottomingSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprIfaceStrictSig</span><span class='hs-layout'>,</span> 
<a name="line-23"></a>        <span class='hs-varid'>returnsCPR</span><span class='hs-layout'>,</span> <span class='hs-varid'>returnsCPRProd</span><span class='hs-layout'>,</span> <span class='hs-varid'>returnsCPR_maybe</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-conid'>StrictSig</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkStrictSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>botSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>cprProdSig</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>isTopSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitStrictSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>increaseStrictSigArity</span><span class='hs-layout'>,</span>
<a name="line-26"></a>       
<a name="line-27"></a>        <span class='hs-varid'>seqDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDemandList</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqStrictSig</span><span class='hs-layout'>,</span> 
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-varid'>evalDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanEvalDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanEvalProdDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStrictDmd</span><span class='hs-layout'>,</span> 
<a name="line-30"></a>        <span class='hs-varid'>splitDmdTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitFVs</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>deferDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>deferType</span><span class='hs-layout'>,</span> <span class='hs-varid'>deferAndUse</span><span class='hs-layout'>,</span> <span class='hs-varid'>deferEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>modifyEnv</span><span class='hs-layout'>,</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-varid'>splitProdDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitProdDmd_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>peelCallDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCallDmd</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>dmdTransformSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdTransformDataConSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>argOneShots</span><span class='hs-layout'>,</span> <span class='hs-varid'>argsOneShots</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-varid'>isSingleUsed</span><span class='hs-layout'>,</span> <span class='hs-varid'>useType</span><span class='hs-layout'>,</span> <span class='hs-varid'>useEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapStrictSig</span><span class='hs-layout'>,</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-varid'>worthSplittingFun</span><span class='hs-layout'>,</span> <span class='hs-varid'>worthSplittingThunk</span>
<a name="line-39"></a>
<a name="line-40"></a>     <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Binary</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>isJust</span><span class='hs-layout'>,</span> <span class='hs-varid'>expectJust</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Strictness domain}
%*                                                                      *
%************************************************************************

        Lazy
         |
      HeadStr
      /     \
  SCall      SProd
      \      /
      HyperStr

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="StrDmd"></a><span class='hs-comment'>-- Vanilla strictness domain</span>
<a name="line-3"></a><a name="StrDmd"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StrDmd</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>             <span class='hs-comment'>-- Hyper-strict </span>
<a name="line-5"></a>                         <span class='hs-comment'>-- Bottom of the lattice</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SCall</span> <span class='hs-conid'>StrDmd</span>         <span class='hs-comment'>-- Call demand</span>
<a name="line-8"></a>                         <span class='hs-comment'>-- Used only for values of function type</span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SProd</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Product</span>
<a name="line-11"></a>                         <span class='hs-comment'>-- Used only for values of product type</span>
<a name="line-12"></a>                         <span class='hs-comment'>-- Invariant: not all components are HyperStr (use HyperStr)</span>
<a name="line-13"></a>                         <span class='hs-comment'>--            not all components are Lazy     (use HeadStr)</span>
<a name="line-14"></a>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HeadStr</span>              <span class='hs-comment'>-- Head-Strict</span>
<a name="line-16"></a>                         <span class='hs-comment'>-- A polymorphic demand: used for values of all types,</span>
<a name="line-17"></a>                         <span class='hs-comment'>--                       including a type variable</span>
<a name="line-18"></a>
<a name="line-19"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="MaybeStr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span>            <span class='hs-comment'>-- Lazy</span>
<a name="line-22"></a>                                <span class='hs-comment'>-- Top of the lattice</span>
<a name="line-23"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Str</span> <span class='hs-conid'>StrDmd</span>
<a name="line-24"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="strBot"></a><span class='hs-comment'>-- Well-formedness preserving constructors for the Strictness domain</span>
<a name="line-27"></a><span class='hs-definition'>strBot</span><span class='hs-layout'>,</span> <span class='hs-varid'>strTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span>
<a name="line-28"></a><span class='hs-definition'>strBot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-conid'>HyperStr</span>
<a name="line-29"></a><a name="strTop"></a><span class='hs-definition'>strTop</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="mkSCall"></a><span class='hs-definition'>mkSCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span>
<a name="line-32"></a><span class='hs-definition'>mkSCall</span> <span class='hs-conid'>HyperStr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-33"></a><span class='hs-definition'>mkSCall</span> <span class='hs-varid'>s</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="mkSProd"></a><span class='hs-definition'>mkSProd</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span>
<a name="line-36"></a><span class='hs-definition'>mkSProd</span> <span class='hs-varid'>sx</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isHyperStr</span> <span class='hs-varid'>sx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isLazy</span>     <span class='hs-varid'>sx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="isLazy"></a><span class='hs-definition'>isLazy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-42"></a><span class='hs-definition'>isLazy</span> <span class='hs-conid'>Lazy</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-43"></a><span class='hs-definition'>isLazy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="isHyperStr"></a><span class='hs-definition'>isHyperStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-46"></a><span class='hs-definition'>isHyperStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HyperStr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-47"></a><span class='hs-definition'>isHyperStr</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="instance%20Outputable%20StrDmd"></a><span class='hs-comment'>-- Pretty-printing</span>
<a name="line-50"></a><a name="instance%20Outputable%20StrDmd"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyword'>where</span>
<a name="line-51"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>HyperStr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'B'</span>
<a name="line-52"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'C'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-53"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>HeadStr</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'S'</span>
<a name="line-54"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'S'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="instance%20Outputable%20MaybeStr"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyword'>where</span>
<a name="line-57"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span>
<a name="line-58"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Lazy</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'L'</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="lubMaybeStr"></a><span class='hs-definition'>lubMaybeStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeStr</span>
<a name="line-61"></a><span class='hs-definition'>lubMaybeStr</span> <span class='hs-conid'>Lazy</span>     <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span>
<a name="line-62"></a><span class='hs-definition'>lubMaybeStr</span> <span class='hs-keyword'>_</span>        <span class='hs-conid'>Lazy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span>
<a name="line-63"></a><span class='hs-definition'>lubMaybeStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`lubStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="lubStr"></a><span class='hs-definition'>lubStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span>
<a name="line-66"></a><span class='hs-definition'>lubStr</span> <span class='hs-conid'>HyperStr</span> <span class='hs-varid'>s</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-67"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-conid'>HyperStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span>
<a name="line-68"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>HeadStr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-69"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`lubStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-71"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span> <span class='hs-conid'>HyperStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span>
<a name="line-72"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>HeadStr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-73"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-74"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s2</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>lubMaybeStr</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-75"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-76"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-77"></a><span class='hs-definition'>lubStr</span> <span class='hs-conid'>HeadStr</span>   <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="bothMaybeStr"></a><span class='hs-definition'>bothMaybeStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeStr</span>
<a name="line-80"></a><span class='hs-definition'>bothMaybeStr</span> <span class='hs-conid'>Lazy</span>     <span class='hs-varid'>s</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-81"></a><span class='hs-definition'>bothMaybeStr</span> <span class='hs-varid'>s</span>        <span class='hs-conid'>Lazy</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> 
<a name="line-82"></a><span class='hs-definition'>bothMaybeStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`bothStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="bothStr"></a><span class='hs-definition'>bothStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span>
<a name="line-85"></a><span class='hs-definition'>bothStr</span> <span class='hs-conid'>HyperStr</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-86"></a><span class='hs-definition'>bothStr</span> <span class='hs-conid'>HeadStr</span> <span class='hs-varid'>s</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-87"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>HyperStr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-88"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-conid'>HeadStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span>
<a name="line-89"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`bothStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>  <span class='hs-comment'>-- Weird</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>HyperStr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-93"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-conid'>HeadStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SProd</span> <span class='hs-varid'>s1</span>
<a name="line-94"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> 
<a name="line-95"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s2</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>bothMaybeStr</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-96"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>  <span class='hs-comment'>-- Weird</span>
<a name="line-97"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="seqStrDmd"></a><span class='hs-comment'>-- utility functions to deal with memory leaks</span>
<a name="line-100"></a><span class='hs-definition'>seqStrDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-101"></a><span class='hs-definition'>seqStrDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqStrDmdList</span> <span class='hs-varid'>ds</span>
<a name="line-102"></a><span class='hs-definition'>seqStrDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span> 
<a name="line-103"></a><span class='hs-definition'>seqStrDmd</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="seqStrDmdList"></a><span class='hs-definition'>seqStrDmdList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-106"></a><span class='hs-definition'>seqStrDmdList</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-107"></a><span class='hs-definition'>seqStrDmdList</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqMaybeStr</span> <span class='hs-varid'>d</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqStrDmdList</span> <span class='hs-varid'>ds</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="seqMaybeStr"></a><span class='hs-definition'>seqMaybeStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-110"></a><span class='hs-definition'>seqMaybeStr</span> <span class='hs-conid'>Lazy</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-111"></a><span class='hs-definition'>seqMaybeStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqStrDmd</span> <span class='hs-varid'>s</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="splitStrProdDmd"></a><span class='hs-comment'>-- Splitting polymorphic demands</span>
<a name="line-114"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span>
<a name="line-115"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-conid'>HyperStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>strBot</span>
<a name="line-116"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-conid'>HeadStr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>strTop</span>
<a name="line-117"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-118"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"attempt to prod-split strictness call demand"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Absence domain}
%*                                                                      *
%************************************************************************

      Used
      /   \
  UCall   UProd
      \   /
      UHead
       |
      Abs

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="UseDmd"></a><span class='hs-comment'>-- Domain for genuine usage</span>
<a name="line-3"></a><a name="UseDmd"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UseDmd</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-conid'>Count</span> <span class='hs-conid'>UseDmd</span>   <span class='hs-comment'>-- Call demand for absence</span>
<a name="line-5"></a>                         <span class='hs-comment'>-- Used only for values of function type</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UProd</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Product </span>
<a name="line-8"></a>                         <span class='hs-comment'>-- Used only for values of product type</span>
<a name="line-9"></a>                         <span class='hs-comment'>-- See Note [Don't optimise UProd(Used) to Used]</span>
<a name="line-10"></a>                         <span class='hs-comment'>-- [Invariant] Not all components are Abs</span>
<a name="line-11"></a>                         <span class='hs-comment'>--             (in that case, use UHead)</span>
<a name="line-12"></a>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UHead</span>                <span class='hs-comment'>-- May be used; but its sub-components are </span>
<a name="line-14"></a>                         <span class='hs-comment'>-- definitely *not* used.  Roughly U(AAA)</span>
<a name="line-15"></a>                         <span class='hs-comment'>-- Eg the usage of x in x `seq` e</span>
<a name="line-16"></a>                         <span class='hs-comment'>-- A polymorphic demand: used for values of all types,</span>
<a name="line-17"></a>                         <span class='hs-comment'>--                       including a type variable</span>
<a name="line-18"></a>                         <span class='hs-comment'>-- Since (UCall _ Abs) is ill-typed, UHead doesn't</span>
<a name="line-19"></a>                         <span class='hs-comment'>-- make sense for lambdas</span>
<a name="line-20"></a>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Used</span>                 <span class='hs-comment'>-- May be used; and its sub-components may be used</span>
<a name="line-22"></a>                         <span class='hs-comment'>-- Top of the lattice</span>
<a name="line-23"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="MaybeUsed"></a><span class='hs-comment'>-- Extended usage demand for absence and counting</span>
<a name="line-26"></a><a name="MaybeUsed"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>                  <span class='hs-comment'>-- Definitely unused</span>
<a name="line-28"></a>                         <span class='hs-comment'>-- Bottom of the lattice</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Count</span> <span class='hs-conid'>UseDmd</span>     <span class='hs-comment'>-- May be used with some cardinality </span>
<a name="line-31"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="Count"></a><span class='hs-comment'>-- Abstract counting of usages</span>
<a name="line-34"></a><a name="Count"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>One</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Many</span>
<a name="line-35"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>     
<a name="line-36"></a>
<a name="line-37"></a><a name="instance%20Outputable%20MaybeUsed"></a><span class='hs-comment'>-- Pretty-printing</span>
<a name="line-38"></a><a name="instance%20Outputable%20MaybeUsed"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyword'>where</span>
<a name="line-39"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Abs</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'A'</span>
<a name="line-40"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span> 
<a name="line-41"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span>  <span class='hs-varid'>a</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'1'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'*'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="instance%20Outputable%20UseDmd"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyword'>where</span>
<a name="line-44"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Used</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'U'</span>
<a name="line-45"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'C'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>c</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>UHead</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'H'</span>
<a name="line-47"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'U'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>','</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="instance%20Outputable%20Count"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Count</span> <span class='hs-keyword'>where</span>
<a name="line-50"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>One</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'1'</span>
<a name="line-51"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Many</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>""</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="countOnce"></a><span class='hs-comment'>-- Well-formedness preserving constructors for the Absence domain</span>
<a name="line-54"></a><span class='hs-definition'>countOnce</span><span class='hs-layout'>,</span> <span class='hs-varid'>countMany</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Count</span>
<a name="line-55"></a><span class='hs-definition'>countOnce</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>One</span>
<a name="line-56"></a><a name="countMany"></a><span class='hs-definition'>countMany</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="useBot"></a><span class='hs-definition'>useBot</span><span class='hs-layout'>,</span> <span class='hs-varid'>useTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-59"></a><span class='hs-definition'>useBot</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-60"></a><a name="useTop"></a><span class='hs-definition'>useTop</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-conid'>Used</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="mkUCall"></a><span class='hs-definition'>mkUCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-63"></a><span class='hs-comment'>--mkUCall c Used = Used c </span>
<a name="line-64"></a><span class='hs-definition'>mkUCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>a</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>a</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="mkUProd"></a><span class='hs-definition'>mkUProd</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-67"></a><span class='hs-definition'>mkUProd</span> <span class='hs-varid'>ux</span> 
<a name="line-68"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UHead</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="lubCount"></a><span class='hs-definition'>lubCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span>
<a name="line-72"></a><span class='hs-definition'>lubCount</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Many</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span>
<a name="line-73"></a><span class='hs-definition'>lubCount</span> <span class='hs-conid'>Many</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span>
<a name="line-74"></a><span class='hs-definition'>lubCount</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> 
<a name="line-75"></a>
<a name="line-76"></a><a name="lubMaybeUsed"></a><span class='hs-definition'>lubMaybeUsed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-77"></a><span class='hs-definition'>lubMaybeUsed</span> <span class='hs-conid'>Abs</span> <span class='hs-varid'>x</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-78"></a><span class='hs-definition'>lubMaybeUsed</span> <span class='hs-varid'>x</span> <span class='hs-conid'>Abs</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-79"></a><span class='hs-definition'>lubMaybeUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubCount</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubUse</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="lubUse"></a><span class='hs-definition'>lubUse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-82"></a><span class='hs-definition'>lubUse</span> <span class='hs-conid'>UHead</span>       <span class='hs-varid'>u</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
<a name="line-83"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-conid'>UHead</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span>
<a name="line-84"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubCount</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubUse</span> <span class='hs-varid'>u1</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-86"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>UHead</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span> 
<a name="line-87"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux2</span><span class='hs-layout'>)</span>
<a name="line-88"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ux1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ux2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>lubMaybeUsed</span> <span class='hs-varid'>ux1</span> <span class='hs-varid'>ux2</span>
<a name="line-89"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-90"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-91"></a><span class='hs-comment'>-- lubUse (UProd {}) Used             = Used</span>
<a name="line-92"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>Used</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`lubMaybeUsed`</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-93"></a><span class='hs-definition'>lubUse</span> <span class='hs-conid'>Used</span>       <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`lubMaybeUsed`</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-94"></a><span class='hs-definition'>lubUse</span> <span class='hs-conid'>Used</span> <span class='hs-keyword'>_</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>  <span class='hs-comment'>-- Note [Used should win]</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-comment'>-- `both` is different from `lub` in its treatment of counting; if</span>
<a name="line-97"></a><span class='hs-comment'>-- `both` is computed for two used, the result always has</span>
<a name="line-98"></a><span class='hs-comment'>--  cardinality `Many` (except for the inner demands of UCall demand -- [TODO] explain).  </span>
<a name="line-99"></a><span class='hs-comment'>--  Also,  x `bothUse` x /= x (for anything but Abs).</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="bothMaybeUsed"></a><span class='hs-definition'>bothMaybeUsed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-102"></a><span class='hs-definition'>bothMaybeUsed</span> <span class='hs-conid'>Abs</span> <span class='hs-varid'>x</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-103"></a><span class='hs-definition'>bothMaybeUsed</span> <span class='hs-varid'>x</span> <span class='hs-conid'>Abs</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-104"></a><span class='hs-definition'>bothMaybeUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-layout'>(</span><span class='hs-varid'>bothUse</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-105"></a>
<a name="line-106"></a>
<a name="line-107"></a><a name="bothUse"></a><span class='hs-definition'>bothUse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-108"></a><span class='hs-definition'>bothUse</span> <span class='hs-conid'>UHead</span>       <span class='hs-varid'>u</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
<a name="line-109"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-conid'>UHead</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span>
<a name="line-110"></a>
<a name="line-111"></a><span class='hs-comment'>-- Exciting special treatment of inner demand for call demands: </span>
<a name="line-112"></a><span class='hs-comment'>--    use `lubUse` instead of `bothUse`!</span>
<a name="line-113"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-conid'>Many</span> <span class='hs-layout'>(</span><span class='hs-varid'>u1</span> <span class='hs-varop'>`lubUse`</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-116"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>UHead</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span> 
<a name="line-117"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux2</span><span class='hs-layout'>)</span>
<a name="line-118"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ux1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ux2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>bothMaybeUsed</span> <span class='hs-varid'>ux1</span> <span class='hs-varid'>ux2</span>
<a name="line-119"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-120"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-121"></a><span class='hs-comment'>-- bothUse (UProd {}) Used             = Used  -- Note [Used should win]</span>
<a name="line-122"></a><span class='hs-definition'>bothUse</span> <span class='hs-conid'>Used</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`bothMaybeUsed`</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-123"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>Used</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`bothMaybeUsed`</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-124"></a><span class='hs-definition'>bothUse</span> <span class='hs-conid'>Used</span> <span class='hs-keyword'>_</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>  <span class='hs-comment'>-- Note [Used should win]</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="peelUseCall"></a><span class='hs-definition'>peelUseCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Count</span><span class='hs-layout'>,</span> <span class='hs-conid'>UseDmd</span><span class='hs-layout'>)</span>
<a name="line-127"></a><span class='hs-definition'>peelUseCall</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-128"></a><span class='hs-definition'>peelUseCall</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

Note [Don't optimise UProd(Used) to Used]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
These two UseDmds:
   UProd [Used, Used]   and    Used
are semantically equivalent, but we do not turn the former into
the latter, for a regrettable-subtle reason.  Suppose we did.
then
  f (x,y) = (y,x)
would get 
  StrDmd = Str  = SProd [Lazy, Lazy]
  UseDmd = Used = UProd [Used, Used]
But with the joint demand of <Str, Used> doesn't convey any clue
that there is a product involved, and so the worthSplittingFun
will not fire.  (We'd need to use the type as well to make it fire.)
Moreover, consider
  g h p@(_,_) = h p
This too would get <Str, Used>, but this time there really isn't any
point in w/w since the components of the pair are not used at all.

So the solution is: don't aggressively collapse UProd [Used,Used] to
Used; intead leave it as-is. In effect we are using the UseDmd to do a
little bit of boxity analysis.  Not very nice.

Note [Used should win]
~~~~~~~~~~~~~~~~~~~~~~
Both in lubUse and bothUse we want (Used `both` UProd us) to be Used.
Why?  Because Used carries the implication the whole thing is used,
box and all, so we don't want to w/w it.  If we use it both boxed and
unboxed, then we are definitely using the box, and so we are quite 
likely to pay a reboxing cost.  So we make Used win here.

Example is in the Buffer argument of GHC.IO.Handle.Internals.writeCharBuffer

Baseline: (A) Not making Used win (UProd wins)
Compare with: (B) making Used win for lub and both

            Min          -0.3%     -5.6%    -10.7%    -11.0%    -33.3%
            Max          +0.3%    +45.6%    +11.5%    +11.5%     +6.9%
 Geometric Mean          -0.0%     +0.5%     +0.3%     +0.2%     -0.8%

Baseline: (B) Making Used win for both lub and both
Compare with: (C) making Used win for both, but UProd win for lub

            Min          -0.1%     -0.3%     -7.9%     -8.0%     -6.5%
            Max          +0.1%     +1.0%    +21.0%    +21.0%     +0.5%
 Geometric Mean          +0.0%     +0.0%     -0.0%     -0.1%     -0.1%


\begin{code}
<pre><a name="line-1"></a><a name="markAsUsedDmd"></a><span class='hs-definition'>markAsUsedDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-2"></a><span class='hs-definition'>markAsUsedDmd</span> <span class='hs-conid'>Abs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-3"></a><span class='hs-definition'>markAsUsedDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-layout'>(</span><span class='hs-varid'>markUsed</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="markUsed"></a><span class='hs-definition'>markUsed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-6"></a><span class='hs-definition'>markUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>u</span>   <span class='hs-comment'>-- No need to recurse here</span>
<a name="line-7"></a><span class='hs-definition'>markUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>markAsUsedDmd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-8"></a><span class='hs-definition'>markUsed</span> <span class='hs-varid'>u</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="isUsedMU"></a><span class='hs-definition'>isUsedMU</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-11"></a><span class='hs-comment'>-- True &lt;=&gt; markAsUsedDmd d = d</span>
<a name="line-12"></a><span class='hs-definition'>isUsedMU</span> <span class='hs-conid'>Abs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-13"></a><span class='hs-definition'>isUsedMU</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-14"></a><span class='hs-definition'>isUsedMU</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUsedU</span> <span class='hs-varid'>u</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="isUsedU"></a><span class='hs-definition'>isUsedU</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-17"></a><span class='hs-comment'>-- True &lt;=&gt; markUsed d = d</span>
<a name="line-18"></a><span class='hs-definition'>isUsedU</span> <span class='hs-conid'>Used</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-19"></a><span class='hs-definition'>isUsedU</span> <span class='hs-conid'>UHead</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-20"></a><span class='hs-definition'>isUsedU</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isUsedMU</span> <span class='hs-varid'>us</span>
<a name="line-21"></a><span class='hs-definition'>isUsedU</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-22"></a><span class='hs-definition'>isUsedU</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>Many</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- No need to recurse</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="seqUseDmd"></a><span class='hs-comment'>-- Squashing usage demand demands</span>
<a name="line-25"></a><span class='hs-definition'>seqUseDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-26"></a><span class='hs-definition'>seqUseDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqMaybeUsedList</span> <span class='hs-varid'>ds</span>
<a name="line-27"></a><span class='hs-definition'>seqUseDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqUseDmd</span> <span class='hs-varid'>d</span>
<a name="line-28"></a><span class='hs-definition'>seqUseDmd</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="seqMaybeUsedList"></a><span class='hs-definition'>seqMaybeUsedList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-31"></a><span class='hs-definition'>seqMaybeUsedList</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-32"></a><span class='hs-definition'>seqMaybeUsedList</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqMaybeUsed</span> <span class='hs-varid'>d</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqMaybeUsedList</span> <span class='hs-varid'>ds</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="seqMaybeUsed"></a><span class='hs-definition'>seqMaybeUsed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-35"></a><span class='hs-definition'>seqMaybeUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqUseDmd</span> <span class='hs-varid'>u</span>
<a name="line-36"></a><span class='hs-definition'>seqMaybeUsed</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="splitUseProdDmd"></a><span class='hs-comment'>-- Splitting polymorphic Maybe-Used demands</span>
<a name="line-39"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span>
<a name="line-40"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-conid'>Used</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>useTop</span>
<a name="line-41"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-conid'>UHead</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-conid'>Abs</span>
<a name="line-42"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>n</span> <span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-43"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"attempt to prod-split usage call demand"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
</pre>\end{code}
  
%************************************************************************
%*                                                                      *
\subsection{Joint domain for Strictness and Absence}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="JointDmd"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-layout'>}</span> 
<a name="line-3"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="instance%20Outputable%20JointDmd"></a><span class='hs-comment'>-- Pretty-printing</span>
<a name="line-6"></a><a name="instance%20Outputable%20JointDmd"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>','</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="mkJointDmd"></a><span class='hs-comment'>-- Well-formedness preserving constructors for the joint domain</span>
<a name="line-10"></a><span class='hs-definition'>mkJointDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-11"></a><span class='hs-definition'>mkJointDmd</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="mkJointDmds"></a><span class='hs-definition'>mkJointDmds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a><span class='hs-definition'>mkJointDmds</span> <span class='hs-varid'>ss</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithEqual</span> <span class='hs-str'>"mkJointDmds"</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-varid'>ss</span> <span class='hs-keyword'>as</span>
<a name="line-15"></a>     
<a name="line-16"></a><a name="absDmd"></a><span class='hs-definition'>absDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-17"></a><span class='hs-definition'>absDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-conid'>Lazy</span> <span class='hs-conid'>Abs</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="topDmd"></a><span class='hs-definition'>topDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-20"></a><span class='hs-definition'>topDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-conid'>Lazy</span> <span class='hs-varid'>useTop</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="seqDmd"></a><span class='hs-definition'>seqDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-23"></a><span class='hs-definition'>seqDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-conid'>UHead</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="botDmd"></a><span class='hs-definition'>botDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-26"></a><span class='hs-definition'>botDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-varid'>strBot</span> <span class='hs-varid'>useBot</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="lubDmd"></a><span class='hs-definition'>lubDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-29"></a><span class='hs-definition'>lubDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-30"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`lubMaybeStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span> <span class='hs-varop'>`lubMaybeUsed`</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="bothDmd"></a><span class='hs-definition'>bothDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-33"></a><span class='hs-definition'>bothDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-34"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`bothMaybeStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span> <span class='hs-varop'>`bothMaybeUsed`</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="isTopDmd"></a><span class='hs-definition'>isTopDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-37"></a><span class='hs-definition'>isTopDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-conid'>Used</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-38"></a><span class='hs-definition'>isTopDmd</span> <span class='hs-keyword'>_</span>                                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> 
<a name="line-39"></a>
<a name="line-40"></a><a name="isBotDmd"></a><span class='hs-definition'>isBotDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-41"></a><span class='hs-definition'>isBotDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-conid'>HyperStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-42"></a><span class='hs-definition'>isBotDmd</span> <span class='hs-keyword'>_</span>                                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> 
<a name="line-43"></a>  
<a name="line-44"></a><a name="isAbsDmd"></a><span class='hs-definition'>isAbsDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-45"></a><span class='hs-definition'>isAbsDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- The strictness part can be HyperStr </span>
<a name="line-46"></a><span class='hs-definition'>isAbsDmd</span> <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- for a bottom demand</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="isSeqDmd"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-49"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>UHead</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-50"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-keyword'>_</span>                                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="seqDemand"></a><span class='hs-comment'>-- More utility functions for strictness</span>
<a name="line-53"></a><span class='hs-definition'>seqDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-54"></a><span class='hs-definition'>seqDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>y</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqMaybeStr</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqMaybeUsed</span> <span class='hs-varid'>y</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="seqDemandList"></a><span class='hs-definition'>seqDemandList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-57"></a><span class='hs-definition'>seqDemandList</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-58"></a><span class='hs-definition'>seqDemandList</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqDemand</span> <span class='hs-varid'>d</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqDemandList</span> <span class='hs-varid'>ds</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="deferDmd"></a><span class='hs-definition'>deferDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-61"></a><span class='hs-definition'>deferDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-conid'>Lazy</span> <span class='hs-varid'>a</span> 
<a name="line-62"></a>
<a name="line-63"></a><a name="isStrictDmd"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-64"></a><span class='hs-comment'>-- See Note [Strict demands]</span>
<a name="line-65"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-66"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-67"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-68"></a>
<a name="line-69"></a><a name="isWeakDmd"></a><span class='hs-definition'>isWeakDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-70"></a><span class='hs-definition'>isWeakDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLazy</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isUsedMU</span> <span class='hs-varid'>a</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="useDmd"></a><span class='hs-definition'>useDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-73"></a><span class='hs-definition'>useDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-varid'>markAsUsedDmd</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="cleanUseDmd_maybe"></a><span class='hs-definition'>cleanUseDmd_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>UseDmd</span>
<a name="line-76"></a><span class='hs-definition'>cleanUseDmd_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ud</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ud</span>
<a name="line-77"></a><span class='hs-definition'>cleanUseDmd_maybe</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="splitFVs"></a><span class='hs-definition'>splitFVs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>   <span class='hs-comment'>-- Thunk</span>
<a name="line-80"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdEnv</span><span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-definition'>splitFVs</span> <span class='hs-varid'>is_thunk</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_thunk</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM_Directly</span> <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionVarEnv</span> <span class='hs-varid'>isWeakDmd</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-84"></a>  <span class='hs-keyword'>where</span>
<a name="line-85"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>dmd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lazy_fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fv</span><span class='hs-layout'>)</span>
<a name="line-86"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Lazy</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>addToUFM_Directly</span> <span class='hs-varid'>lazy_fv</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fv</span><span class='hs-layout'>)</span>
<a name="line-87"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>addToUFM_Directly</span> <span class='hs-varid'>lazy_fv</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-88"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>addToUFM_Directly</span> <span class='hs-varid'>sig_fv</span>  <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span>    <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Clean demand for Strictness and Usage}
%*                                                                      *
%************************************************************************

This domain differst from JointDemand in the sence that pure absence
is taken away, i.e., we deal *only* with non-absent demands.

Note [Strict demands]
~~~~~~~~~~~~~~~~~~~~~
isStrictDmd returns true only of demands that are 
   both strict
   and  used
In particular, it is False for <HyperStr, Abs>, which can and does
arise in, say (Trac #7319)
   f x = raise# <some exception>
Then 'x' is not used, so f gets strictness <HyperStr,Abs> -> .
Now the w/w generates
   fx = let x <HyperStr,Abs> = absentError "unused"
        in raise <some exception>
At this point we really don't want to convert to
   fx = case absentError "unused" of x -> raise <some exception>
Since the program is going to diverge, this swaps one error for another,
but it's really a bad idea to *ever* evaluate an absent argument.
In Trac #7319 we get
   T7319.exe: Oops!  Entered absent arg w_s1Hd{v} [lid] [base:GHC.Base.String{tc 36u}]

Note [Dealing with call demands]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Call demands are constructed and deconstructed coherently for
strictness and absence. For instance, the strictness signature for the
following function

f :: (Int -> (Int, Int)) -> (Int, Bool)
f g = (snd (g 3), True)

should be: <L,C(U(AU))>m


\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="CleanDemand"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-layout'>}</span> 
<a name="line-3"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="instance%20Outputable%20CleanDemand"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyword'>where</span>
<a name="line-6"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="mkCleanDmd"></a><span class='hs-definition'>mkCleanDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-9"></a><span class='hs-definition'>mkCleanDmd</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="bothCleanDmd"></a><span class='hs-definition'>bothCleanDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-12"></a><span class='hs-definition'>bothCleanDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>`bothStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span> <span class='hs-varop'>`bothUse`</span> <span class='hs-varid'>a2</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="mkHeadStrict"></a><span class='hs-definition'>mkHeadStrict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-16"></a><span class='hs-definition'>mkHeadStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-conid'>HeadStr</span> <span class='hs-varid'>a</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="oneifyDmd"></a><span class='hs-definition'>oneifyDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-19"></a><span class='hs-definition'>oneifyDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-20"></a><span class='hs-definition'>oneifyDmd</span> <span class='hs-varid'>jd</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>jd</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="mkOnceUsedDmd"></a><span class='hs-definition'>mkOnceUsedDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkManyUsedDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-23"></a><span class='hs-definition'>mkOnceUsedDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-24"></a><a name="mkManyUsedDmd"></a><span class='hs-definition'>mkManyUsedDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="getUsage"></a><span class='hs-definition'>getUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-27"></a><span class='hs-definition'>getUsage</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ud</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="evalDmd"></a><span class='hs-definition'>evalDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-30"></a><span class='hs-comment'>-- Evaluated strictly, and used arbitrarily deeply</span>
<a name="line-31"></a><span class='hs-definition'>evalDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>)</span> <span class='hs-varid'>useTop</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="mkProdDmd"></a><span class='hs-definition'>mkProdDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-34"></a><span class='hs-definition'>mkProdDmd</span> <span class='hs-varid'>dx</span> 
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>up</span> 
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-varid'>sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSProd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>strd</span> <span class='hs-varid'>dx</span>
<a name="line-38"></a>    <span class='hs-varid'>up</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUProd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>absd</span> <span class='hs-varid'>dx</span>   
<a name="line-39"></a>
<a name="line-40"></a><a name="mkCallDmd"></a><span class='hs-definition'>mkCallDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-41"></a><span class='hs-definition'>mkCallDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSCall</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUCall</span> <span class='hs-conid'>One</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="peelCallDmd"></a><span class='hs-comment'>-- Returns result demand * strictness flag * one-shotness of the call </span>
<a name="line-45"></a><span class='hs-definition'>peelCallDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> 
<a name="line-46"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-47"></a>               <span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span>      <span class='hs-comment'>-- True &lt;=&gt; had to strengthen from HeadStr</span>
<a name="line-48"></a>                           <span class='hs-comment'>--          hence defer results</span>
<a name="line-49"></a>               <span class='hs-layout'>,</span> <span class='hs-conid'>Count</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Call count</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-comment'>-- Exploiting the fact that </span>
<a name="line-52"></a><span class='hs-comment'>-- on the strictness side      C(B) = B</span>
<a name="line-53"></a><span class='hs-comment'>-- and on the usage side       C(U) = U </span>
<a name="line-54"></a><span class='hs-definition'>peelCallDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>peel_s</span> <span class='hs-varid'>s</span>
<a name="line-56"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>u'</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>peel_u</span> <span class='hs-varid'>u</span>
<a name="line-57"></a>    <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkCleanDmd</span> <span class='hs-varid'>s'</span> <span class='hs-varid'>u'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span>
<a name="line-59"></a>    <span class='hs-varid'>peel_s</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span>        <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-60"></a>    <span class='hs-varid'>peel_s</span> <span class='hs-conid'>HyperStr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>HyperStr</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-61"></a>    <span class='hs-varid'>peel_s</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span>  <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a>    <span class='hs-varid'>peel_u</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span>       <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-64"></a>    <span class='hs-varid'>peel_u</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Used</span><span class='hs-layout'>,</span> <span class='hs-conid'>Many</span><span class='hs-layout'>)</span>
<a name="line-65"></a>       <span class='hs-comment'>-- The last case includes UHead which seems a bit wrong</span>
<a name="line-66"></a>       <span class='hs-comment'>-- because the body isn't used at all!</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="cleanEvalDmd"></a><span class='hs-definition'>cleanEvalDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-69"></a><span class='hs-definition'>cleanEvalDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-conid'>HeadStr</span> <span class='hs-conid'>Used</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="cleanEvalProdDmd"></a><span class='hs-definition'>cleanEvalProdDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-72"></a><span class='hs-definition'>cleanEvalProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-conid'>HeadStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="isSingleUsed"></a><span class='hs-definition'>isSingleUsed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-75"></a><span class='hs-definition'>isSingleUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_used_once</span> <span class='hs-varid'>a</span>
<a name="line-76"></a>  <span class='hs-keyword'>where</span>
<a name="line-77"></a>    <span class='hs-varid'>is_used_once</span> <span class='hs-conid'>Abs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-78"></a>    <span class='hs-varid'>is_used_once</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-79"></a>    <span class='hs-varid'>is_used_once</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Note [Threshold demands]
~~~~~~~~~~~~~~~~~~~~~~~~
Threshold usage demand is generated to figure out if
cardinality-instrumented demands of a binding's free variables should
be unleashed. See also [Aggregated demand for cardinality].

Note [Replicating polymorphic demands]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Some demands can be considered as polymorphic. Generally, it is
applicable to such beasts as tops, bottoms as well as Head-Used adn
Head-stricts demands. For instance,

S ~ S(L, ..., L)

Also, when top or bottom is occurred as a result demand, it in fact
can be expanded to saturate a callee's arity. 


\begin{code}
<pre><a name="line-1"></a><a name="splitProdDmd"></a><span class='hs-definition'>splitProdDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>splitProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmds</span> <span class='hs-layout'>(</span><span class='hs-varid'>split_str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>split_abs</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>split_str</span> <span class='hs-conid'>Lazy</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-conid'>Lazy</span>
<a name="line-6"></a>    <span class='hs-varid'>split_str</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitStrProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-varid'>s</span>
<a name="line-7"></a>
<a name="line-8"></a>    <span class='hs-varid'>split_abs</span> <span class='hs-conid'>Abs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-conid'>Abs</span>
<a name="line-9"></a>    <span class='hs-varid'>split_abs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUseProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-varid'>u</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="splitProdDmd_maybe"></a><span class='hs-definition'>splitProdDmd_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a><span class='hs-comment'>-- Split a product into its components, iff there is any</span>
<a name="line-13"></a><span class='hs-comment'>-- useful information to be extracted thereby</span>
<a name="line-14"></a><span class='hs-comment'>-- The demand is not necessarily strict!</span>
<a name="line-15"></a><span class='hs-definition'>splitProdDmd_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-17"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkJointDmds</span> <span class='hs-varid'>sx</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitUseProdDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkJointDmds</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitStrProdDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-19"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span>           <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkJointDmds</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>)</span>    <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-20"></a>      <span class='hs-keyword'>_</span>                                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Demand results}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- Constructed Product Result                                             </span>
<a name="line-3"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="CPRResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCPR</span>              <span class='hs-comment'>-- Top of the lattice</span>
<a name="line-6"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RetProd</span>            <span class='hs-comment'>-- Returns a constructor from a product type</span>
<a name="line-7"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RetSum</span> <span class='hs-conid'>ConTag</span>      <span class='hs-comment'>-- Returns a constructor from a sum type with this tag</span>
<a name="line-8"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BotCPR</span>             <span class='hs-comment'>-- Returns a constructor with any tag</span>
<a name="line-9"></a>                                    <span class='hs-comment'>-- Bottom of the domain</span>
<a name="line-10"></a>               <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="lubCPR"></a><span class='hs-definition'>lubCPR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CPRResult</span>
<a name="line-13"></a><span class='hs-definition'>lubCPR</span> <span class='hs-conid'>BotCPR</span>      <span class='hs-varid'>r</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-14"></a><span class='hs-definition'>lubCPR</span> <span class='hs-conid'>RetProd</span>     <span class='hs-conid'>BotCPR</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetProd</span>
<a name="line-15"></a><span class='hs-definition'>lubCPR</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>  <span class='hs-conid'>BotCPR</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetSum</span> <span class='hs-varid'>t</span>
<a name="line-16"></a><span class='hs-definition'>lubCPR</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> 
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>t2</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetSum</span> <span class='hs-varid'>t1</span>
<a name="line-18"></a><span class='hs-definition'>lubCPR</span> <span class='hs-conid'>RetProd</span>     <span class='hs-conid'>RetProd</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetProd</span>
<a name="line-19"></a><span class='hs-definition'>lubCPR</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCPR</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="bothCPR"></a><span class='hs-definition'>bothCPR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CPRResult</span>
<a name="line-22"></a><span class='hs-comment'>-- See Note [Asymmetry of 'both' for DmdType and DmdResult]</span>
<a name="line-23"></a><span class='hs-definition'>bothCPR</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>BotCPR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BotCPR</span>   <span class='hs-comment'>-- If either diverges, we diverge</span>
<a name="line-24"></a><span class='hs-definition'>bothCPR</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="instance%20Outputable%20DmdResult"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyword'>where</span>
<a name="line-27"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RetProd</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'m'</span> 
<a name="line-28"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'m'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span>  
<a name="line-29"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>BotCPR</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'b'</span>   
<a name="line-30"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoCPR</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>   <span class='hs-comment'>-- Keep these distinct from Demand letters</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="DmdResult"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-33"></a><a name="DmdResult"></a><span class='hs-comment'>-- Combined demand result                                             --</span>
<a name="line-34"></a><a name="DmdResult"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-35"></a><a name="DmdResult"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CPRResult</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="lubDmdResult"></a><span class='hs-definition'>lubDmdResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-38"></a><span class='hs-definition'>lubDmdResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lubCPR</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="bothDmdResult"></a><span class='hs-definition'>bothDmdResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-41"></a><span class='hs-definition'>bothDmdResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bothCPR</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="seqDmdResult"></a><span class='hs-definition'>seqDmdResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-44"></a><span class='hs-definition'>seqDmdResult</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="topRes"></a><span class='hs-comment'>-- [cprRes] lets us switch off CPR analysis</span>
<a name="line-47"></a><span class='hs-comment'>-- by making sure that everything uses TopRes</span>
<a name="line-48"></a><span class='hs-definition'>topRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>botRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span>
<a name="line-49"></a><span class='hs-definition'>topRes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCPR</span>
<a name="line-50"></a><a name="botRes"></a><span class='hs-definition'>botRes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BotCPR</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="cprSumRes"></a><span class='hs-definition'>cprSumRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConTag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-53"></a><span class='hs-definition'>cprSumRes</span> <span class='hs-varid'>tag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_CprOff</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topRes</span>
<a name="line-54"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetSum</span> <span class='hs-varid'>tag</span>
<a name="line-55"></a><a name="cprProdRes"></a><span class='hs-definition'>cprProdRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span>
<a name="line-56"></a><span class='hs-definition'>cprProdRes</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_CprOff</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topRes</span>
<a name="line-57"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetProd</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="isTopRes"></a><span class='hs-definition'>isTopRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-60"></a><span class='hs-definition'>isTopRes</span> <span class='hs-conid'>NoCPR</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-61"></a><span class='hs-definition'>isTopRes</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="isBotRes"></a><span class='hs-definition'>isBotRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-64"></a><span class='hs-definition'>isBotRes</span> <span class='hs-conid'>BotCPR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-65"></a><span class='hs-definition'>isBotRes</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="returnsCPR"></a><span class='hs-definition'>returnsCPR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-68"></a><span class='hs-definition'>returnsCPR</span> <span class='hs-varid'>dr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>returnsCPR_maybe</span> <span class='hs-varid'>dr</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="returnsCPRProd"></a><span class='hs-definition'>returnsCPRProd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-71"></a><span class='hs-definition'>returnsCPRProd</span> <span class='hs-conid'>RetProd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-72"></a><span class='hs-definition'>returnsCPRProd</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="returnsCPR_maybe"></a><span class='hs-definition'>returnsCPR_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ConTag</span>
<a name="line-75"></a><span class='hs-definition'>returnsCPR_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t</span>
<a name="line-76"></a><span class='hs-definition'>returnsCPR_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetProd</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>fIRST_TAG</span>
<a name="line-77"></a><span class='hs-definition'>returnsCPR_maybe</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="resTypeArgDmd"></a><span class='hs-definition'>resTypeArgDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-80"></a><span class='hs-comment'>-- TopRes and BotRes are polymorphic, so that</span>
<a name="line-81"></a><span class='hs-comment'>--      BotRes === Bot -&gt; BotRes === ...</span>
<a name="line-82"></a><span class='hs-comment'>--      TopRes === Top -&gt; TopRes === ...</span>
<a name="line-83"></a><span class='hs-comment'>-- This function makes that concrete</span>
<a name="line-84"></a><span class='hs-definition'>resTypeArgDmd</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>botDmd</span>
<a name="line-85"></a><span class='hs-definition'>resTypeArgDmd</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topDmd</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
            Whether a demand justifies a w/w split
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="worthSplittingFun"></a><span class='hs-definition'>worthSplittingFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a>                <span class='hs-comment'>-- True &lt;=&gt; the wrapper would not be an identity function</span>
<a name="line-3"></a><span class='hs-definition'>worthSplittingFun</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>worth_it</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>returnsCPR</span> <span class='hs-varid'>res</span>
<a name="line-5"></a>        <span class='hs-comment'>-- worthSplitting returns False for an empty list of demands,</span>
<a name="line-6"></a>        <span class='hs-comment'>-- and hence do_strict_ww is False if arity is zero and there is no CPR</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>worth_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Abs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>      <span class='hs-comment'>-- Absent arg</span>
<a name="line-9"></a>
<a name="line-10"></a>    <span class='hs-comment'>-- See Note [Worker-wrapper for bottoming functions]</span>
<a name="line-11"></a>    <span class='hs-varid'>worth_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HyperStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-12"></a>
<a name="line-13"></a>    <span class='hs-comment'>-- See Note [Worthy functions for Worker-Wrapper split]    </span>
<a name="line-14"></a>    <span class='hs-varid'>worth_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Str</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- Product arg to evaluate</span>
<a name="line-15"></a>    <span class='hs-varid'>worth_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- Strictly used product arg</span>
<a name="line-16"></a>    <span class='hs-varid'>worth_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>UHead</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> 
<a name="line-17"></a>    <span class='hs-varid'>worth_it</span> <span class='hs-keyword'>_</span>                                            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="worthSplittingThunk"></a><span class='hs-definition'>worthSplittingThunk</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>         <span class='hs-comment'>-- Demand on the thunk</span>
<a name="line-20"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>        <span class='hs-comment'>-- CPR info for the thunk</span>
<a name="line-21"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-22"></a><span class='hs-definition'>worthSplittingThunk</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>res</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>worth_it</span> <span class='hs-varid'>dmd</span> <span class='hs-varop'>||</span> <span class='hs-varid'>returnsCPR</span> <span class='hs-varid'>res</span>
<a name="line-24"></a>  <span class='hs-keyword'>where</span>
<a name="line-25"></a>        <span class='hs-comment'>-- Split if the thing is unpacked</span>
<a name="line-26"></a>    <span class='hs-varid'>worth_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Str</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>some_comp_used</span> <span class='hs-varid'>a</span>
<a name="line-27"></a>    <span class='hs-varid'>worth_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   
<a name="line-28"></a>        <span class='hs-comment'>-- second component points out that at least some of     </span>
<a name="line-29"></a>    <span class='hs-varid'>worth_it</span> <span class='hs-keyword'>_</span>                                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-30"></a>
<a name="line-31"></a>    <span class='hs-varid'>some_comp_used</span> <span class='hs-conid'>Used</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-32"></a>    <span class='hs-varid'>some_comp_used</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-33"></a>    <span class='hs-varid'>some_comp_used</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-34"></a>
<a name="line-35"></a>
</pre>\end{code}

Note [Worthy functions for Worker-Wrapper split]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
For non-bottoming functions a worker-wrapper transformation takes into
account several possibilities to decide if the function is worthy for
splitting:

1. The result is of product type and the function is strict in some
(or even all) of its arguments. The check that the argument is used is
more of sanity nature, since strictness implies usage. Example:

f :: (Int, Int) -> Int
f p = (case p of (a,b) -> a) + 1

should be splitted to

f :: (Int, Int) -> Int
f p = case p of (a,b) -> $wf a

$wf :: Int -> Int
$wf a = a + 1

2. Sometimes it also makes sense to perform a WW split if the
strictness analysis cannot say for sure if the function is strict in
components of its argument. Then we reason according to the inferred
usage information: if the function uses its product argument's
components, the WW split can be beneficial. Example:

g :: Bool -> (Int, Int) -> Int
g c p = case p of (a,b) -> 
          if c then a else b

The function g is strict in is argument p and lazy in its
components. However, both components are used in the RHS. The idea is
since some of the components (both in this case) are used in the
right-hand side, the product must presumable be taken apart.

Therefore, the WW transform splits the function g to

g :: Bool -> (Int, Int) -> Int
g c p = case p of (a,b) -> $wg c a b

$wg :: Bool -> Int -> Int -> Int
$wg c a b = if c then a else b

3. If an argument is absent, it would be silly to pass it to a
function, hence the worker with reduced arity is generated.


Note [Worker-wrapper for bottoming functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used not to split if the result is bottom.
[Justification:  there's no efficiency to be gained.]

But it's sometimes bad not to make a wrapper.  Consider
        fw = \x# -> let x = I# x# in case e of
                                        p1 -> error_fn x
                                        p2 -> error_fn x
                                        p3 -> the real stuff
The re-boxing code won't go away unless error_fn gets a wrapper too.
[We don't do reboxing now, but in general it's better to pass an
unboxed thing to f, and have it reboxed in the error cases....]

However we *don't* want to do this when the argument is not actually
taken apart in the function at all.  Otherwise we risk decomposing a
masssive tuple which is barely used.  Example:

        f :: ((Int,Int) -> String) -> (Int,Int) -> a
        f g pr = error (g pr)

        main = print (f fst (1, error "no"))
          
Here, f does not take 'pr' apart, and it's stupid to do so.
Imagine that it had millions of fields. This actually happened
in GHC itself where the tuple was DynFlags


%************************************************************************
%*                                                                      *
\subsection{Demand environments and types}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Demand"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JointDmd</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="DmdEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Demand</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="DmdType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> 
<a name="line-6"></a>                  <span class='hs-conid'>DmdEnv</span>        <span class='hs-comment'>-- Demand on explicitly-mentioned </span>
<a name="line-7"></a>                                <span class='hs-comment'>--      free variables</span>
<a name="line-8"></a>                  <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- Demand on arguments</span>
<a name="line-9"></a>                  <span class='hs-conid'>DmdResult</span>     <span class='hs-comment'>-- Nature of result</span>
</pre>\end{code}

Note [Nature of result demand]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We assume the result in a demand type to be either a top or bottom
in order to represent the information about demand on the function
result, imposed by its definition. There are not so many things we 
can say, though. 

For instance, one can consider a function

        h = \v -> error "urk"

Taking the definition of strictness, we can easily see that 

        h undefined = undefined

that is, h is strict in v. However, v is not used somehow in the body
of h How can we know that h is strict in v? In fact, we know it by
considering a result demand of error and bottom and unleashing it on
all the variables in scope at a call site (in this case, this is only
v). We can also consider a case

       h = \v -> f x

where we know that the result of f is not hyper-strict (i.e, it is
lazy, or top). So, we put the same demand on v, which allow us to
infer a lazy demand that h puts on v.

Note [Asymmetry of 'both' for DmdType and DmdResult]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'both' for DmdTypes is *assymetrical*, because there is only one
result!  For example, given (e1 e2), we get a DmdType dt1 for e1, use
its arg demand to analyse e2 giving dt2, and then do (dt1 `bothType` dt2).
Similarly with 
  case e of { p -> rhs }
we get dt_scrut from the scrutinee and dt_rhs from the RHS, and then
compute (dt_rhs `bothType` dt_scrut).

We take the CPR info from FIRST argument, but combine both to get
termination info.


\begin{code}
<pre><a name="line-1"></a><a name="instance%20Eq%20DmdType"></a><span class='hs-comment'>-- Equality needed for fixpoints in DmdAnal</span>
<a name="line-2"></a><a name="instance%20Eq%20DmdType"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyword'>where</span>
<a name="line-3"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>res1</span><span class='hs-layout'>)</span>
<a name="line-4"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>ds2</span> <span class='hs-varid'>res2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>ufmToList</span> <span class='hs-varid'>fv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ufmToList</span> <span class='hs-varid'>fv2</span>
<a name="line-5"></a>                              <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ds1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ds2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>res1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>res2</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="lubDmdType"></a><span class='hs-definition'>lubDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-8"></a><span class='hs-definition'>lubDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>ds2</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>lub_fv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>lub_ds</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span> <span class='hs-varop'>`lubDmdResult`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>absLub</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lubDmd</span> <span class='hs-varid'>absDmd</span>
<a name="line-12"></a>    <span class='hs-varid'>lub_fv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_C</span> <span class='hs-varid'>lubDmd</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span>
<a name="line-13"></a>    <span class='hs-comment'>-- Consider (if x then y else []) with demand V</span>
<a name="line-14"></a>    <span class='hs-comment'>-- Then the first branch gives {y-&gt;V} and the second</span>
<a name="line-15"></a>    <span class='hs-comment'>-- *implicitly* has {y-&gt;A}.  So we must put {y-&gt;(V `lub` A)}</span>
<a name="line-16"></a>    <span class='hs-comment'>-- in the result env.</span>
<a name="line-17"></a>    <span class='hs-varid'>lub_fv1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>absLub</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>lub_fv</span>
<a name="line-18"></a>    <span class='hs-varid'>lub_fv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>absLub</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>lub_fv1</span>
<a name="line-19"></a>      <span class='hs-comment'>-- lub is the identity for Bot</span>
<a name="line-20"></a>
<a name="line-21"></a>      <span class='hs-comment'>-- Extend the shorter argument list to match the longer</span>
<a name="line-22"></a>    <span class='hs-varid'>lub_ds</span> <span class='hs-layout'>(</span><span class='hs-varid'>d1</span><span class='hs-conop'>:</span><span class='hs-varid'>ds1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>d2</span><span class='hs-conop'>:</span><span class='hs-varid'>ds2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lubDmd</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d2</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lub_ds</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span>
<a name="line-23"></a>    <span class='hs-varid'>lub_ds</span> <span class='hs-conid'>[]</span>     <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-24"></a>    <span class='hs-varid'>lub_ds</span> <span class='hs-varid'>ds1</span>    <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`lubDmd`</span> <span class='hs-varid'>resTypeArgDmd</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds1</span>
<a name="line-25"></a>    <span class='hs-varid'>lub_ds</span> <span class='hs-conid'>[]</span>     <span class='hs-varid'>ds2</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>resTypeArgDmd</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>`lubDmd`</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds2</span>
<a name="line-26"></a> 
<a name="line-27"></a><a name="bothDmdType"></a><span class='hs-definition'>bothDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-28"></a><span class='hs-definition'>bothDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv2</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-29"></a>    <span class='hs-comment'>-- See Note [Asymmetry of 'both' for DmdType and DmdResult]</span>
<a name="line-30"></a>    <span class='hs-comment'>-- 'both' takes the argument/result info from its *first* arg,</span>
<a name="line-31"></a>    <span class='hs-comment'>-- using its second arg just for its free-var info.</span>
<a name="line-32"></a>    <span class='hs-comment'>-- NB: Don't forget about r2!  It might be BotRes, which is</span>
<a name="line-33"></a>    <span class='hs-comment'>-- a bottom demand on all the in-scope variables.</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>both_fv2</span> <span class='hs-varid'>ds1</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span> <span class='hs-varop'>`bothDmdResult`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyword'>where</span>
<a name="line-36"></a>    <span class='hs-varid'>both_fv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_C</span> <span class='hs-varid'>bothDmd</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span>
<a name="line-37"></a>    <span class='hs-varid'>both_fv1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>`bothDmd`</span> <span class='hs-varid'>botDmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>both_fv</span>
<a name="line-38"></a>    <span class='hs-varid'>both_fv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>`bothDmd`</span> <span class='hs-varid'>botDmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>both_fv1</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="bothDmdEnv"></a><span class='hs-definition'>bothDmdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-41"></a><span class='hs-definition'>bothDmdEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_C</span> <span class='hs-varid'>bothDmd</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="instance%20Outputable%20DmdType"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyword'>where</span>
<a name="line-44"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> 
<a name="line-45"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"DmdType"</span><span class='hs-layout'>,</span>
<a name="line-46"></a>            <span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res</span><span class='hs-layout'>,</span>
<a name="line-47"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fv_elts</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>empty</span>
<a name="line-48"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp_elt</span> <span class='hs-varid'>fv_elts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-49"></a>    <span class='hs-keyword'>where</span>
<a name="line-50"></a>      <span class='hs-varid'>pp_elt</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>uniq</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"-&gt;"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dmd</span>
<a name="line-51"></a>      <span class='hs-varid'>fv_elts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ufmToList</span> <span class='hs-varid'>fv</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="emptyDmdEnv"></a><span class='hs-definition'>emptyDmdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Demand</span>
<a name="line-54"></a><span class='hs-definition'>emptyDmdEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="topDmdType"></a><span class='hs-definition'>topDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span>
<a name="line-57"></a><span class='hs-definition'>topDmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>topRes</span>
<a name="line-58"></a><a name="botDmdType"></a><span class='hs-definition'>botDmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>botRes</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="cprProdDmdType"></a><span class='hs-definition'>cprProdDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span>
<a name="line-61"></a><span class='hs-definition'>cprProdDmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>cprProdRes</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="isTopDmdType"></a><span class='hs-definition'>isTopDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-64"></a><span class='hs-definition'>isTopDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopRes</span> <span class='hs-varid'>res</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-66"></a><span class='hs-definition'>isTopDmdType</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="mkDmdType"></a><span class='hs-definition'>mkDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-69"></a><span class='hs-definition'>mkDmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="mkTopDmdType"></a><span class='hs-definition'>mkTopDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-72"></a><span class='hs-definition'>mkTopDmdType</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="dmdTypeDepth"></a><span class='hs-definition'>dmdTypeDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-75"></a><span class='hs-definition'>dmdTypeDepth</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ds</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="seqDmdType"></a><span class='hs-definition'>seqDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-78"></a><span class='hs-definition'>seqDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-79"></a>  <span class='hs-comment'>{- ??? env `seq` -}</span> <span class='hs-varid'>seqDemandList</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqDmdResult</span> <span class='hs-varid'>res</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="splitDmdTy"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Demand</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdType</span><span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-comment'>-- Split off one function argument</span>
<a name="line-83"></a><span class='hs-comment'>-- We already have a suitable demand on all</span>
<a name="line-84"></a><span class='hs-comment'>-- free vars, so no need to add more!</span>
<a name="line-85"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd</span><span class='hs-conop'>:</span><span class='hs-varid'>dmds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>resTypeArgDmd</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="deferAndUse"></a><span class='hs-definition'>deferAndUse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- Lazify (defer) the type</span>
<a name="line-89"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span>   <span class='hs-comment'>-- Many =&gt; manify the type</span>
<a name="line-90"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-91"></a><span class='hs-definition'>deferAndUse</span> <span class='hs-conid'>True</span>  <span class='hs-conid'>Many</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferType</span> <span class='hs-layout'>(</span><span class='hs-varid'>useType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-92"></a><span class='hs-definition'>deferAndUse</span> <span class='hs-conid'>False</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>useType</span> <span class='hs-varid'>ty</span>
<a name="line-93"></a><span class='hs-definition'>deferAndUse</span> <span class='hs-conid'>True</span>  <span class='hs-conid'>One</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferType</span> <span class='hs-varid'>ty</span>
<a name="line-94"></a><span class='hs-definition'>deferAndUse</span> <span class='hs-conid'>False</span> <span class='hs-conid'>One</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="deferType"></a><span class='hs-definition'>deferType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-97"></a><span class='hs-comment'>-- deferType ty1 ==  ty1 `lubType` DT { v -&gt; &lt;L,A&gt; } [] top }</span>
<a name="line-98"></a><span class='hs-comment'>-- Ie it might be used, or not </span>
<a name="line-99"></a><span class='hs-definition'>deferType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>deferEnv</span> <span class='hs-varid'>fv</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>topRes</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="deferEnv"></a><span class='hs-definition'>deferEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-102"></a><span class='hs-definition'>deferEnv</span> <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-varid'>deferDmd</span> <span class='hs-varid'>fv</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="useType"></a><span class='hs-definition'>useType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-105"></a><span class='hs-comment'>-- useType ty1 == ty1 `bothType` ty1</span>
<a name="line-106"></a><span class='hs-comment'>-- NB that bothType is assymetrical, so no-op on argument demands</span>
<a name="line-107"></a><span class='hs-definition'>useType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>useEnv</span> <span class='hs-varid'>fv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res_ty</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="useEnv"></a><span class='hs-definition'>useEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-110"></a><span class='hs-definition'>useEnv</span> <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-varid'>useDmd</span> <span class='hs-varid'>fv</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="modifyEnv"></a><span class='hs-definition'>modifyEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                       <span class='hs-comment'>-- No-op if False</span>
<a name="line-113"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- The zapper</span>
<a name="line-114"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>           <span class='hs-comment'>-- Env1 and Env2</span>
<a name="line-115"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>           <span class='hs-comment'>-- Transform this env</span>
<a name="line-116"></a>        <span class='hs-comment'>-- Zap anything in Env1 but not in Env2</span>
<a name="line-117"></a>        <span class='hs-comment'>-- Assume: dom(env) includes dom(Env1) and dom(Env2)</span>
<a name="line-118"></a><span class='hs-definition'>modifyEnv</span> <span class='hs-varid'>need_to_modify</span> <span class='hs-varid'>zapper</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>env</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>need_to_modify</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>zap</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvKeys</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span> <span class='hs-varop'>`minusUFM`</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-120"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-121"></a>  <span class='hs-keyword'>where</span>
<a name="line-122"></a>    <span class='hs-varid'>zap</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM_Directly</span> <span class='hs-varid'>env</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapper</span> <span class='hs-varid'>current_val</span><span class='hs-layout'>)</span>
<a name="line-123"></a>                 <span class='hs-keyword'>where</span>
<a name="line-124"></a>                   <span class='hs-varid'>current_val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"modifyEnv"</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupUFM_Directly</span> <span class='hs-varid'>env</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="strictenDmd"></a><span class='hs-definition'>strictenDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-127"></a><span class='hs-definition'>strictenDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-128"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke_s</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke_u</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span>
<a name="line-129"></a>  <span class='hs-keyword'>where</span>
<a name="line-130"></a>    <span class='hs-varid'>poke_s</span> <span class='hs-conid'>Lazy</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-131"></a>    <span class='hs-varid'>poke_s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-132"></a>    <span class='hs-varid'>poke_u</span> <span class='hs-conid'>Abs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UHead</span>
<a name="line-133"></a>    <span class='hs-varid'>poke_u</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="toCleanDmd"></a><span class='hs-definition'>toCleanDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-136"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-137"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-138"></a><span class='hs-comment'>-- See Note [Analyzing with lazy demand and lambdas]</span>
<a name="line-139"></a><span class='hs-definition'>toCleanDmd</span> <span class='hs-varid'>anal</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-140"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-141"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mf</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>topDmdType</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>anal</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-142"></a>                  <span class='hs-comment'>--  See Note [Always analyse in virgin pass]</span>
<a name="line-143"></a>             
<a name="line-144"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mf</span> <span class='hs-layout'>(</span><span class='hs-varid'>deferAndUse</span> <span class='hs-conid'>False</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>anal</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span>      <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-145"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span>   <span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mf</span> <span class='hs-layout'>(</span><span class='hs-varid'>deferAndUse</span> <span class='hs-conid'>True</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-varid'>anal</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-146"></a>  <span class='hs-keyword'>where</span>
<a name="line-147"></a>    <span class='hs-varid'>mf</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Always analyse in virgin pass]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Tricky point: make sure that we analyse in the 'virgin' pass. Consider
   rec { f acc x True  = f (...rec { g y = ...g... }...)
         f acc x False = acc }
In the virgin pass for 'f' we'll give 'f' a very strict (bottom) type.
That might mean that we analyse the sub-expression containing the 
E = "...rec g..." stuff in a bottom demand.  Suppose we *didn't analyse*
E, but just retuned botType.  

Then in the *next* (non-virgin) iteration for 'f', we might analyse E
in a weaker demand, and that will trigger doing a fixpoint iteration
for g.  But *because it's not the virgin pass* we won't start g's
iteration at bottom.  Disaster.  (This happened in $sfibToList' of 
nofib/spectral/fibheaps.)

So in the virgin pass we make sure that we do analyse the expression
at least once, to initialise its signatures.

Note [Analyzing with lazy demand and lambdas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The insight for analyzing lambdas follows from the fact that for
strictness S = C(L). This polymorphic expansion is critical for
cardinality analysis of the following example:

{-# NOINLINE build #-}
build g = (g (:) [], g (:) [])

h c z = build (\x -> 
                let z1 = z ++ z 
                 in if c
                    then \y -> x (y ++ z1)
                    else \y -> x (z1 ++ y))

One can see that `build` assigns to `g` demand <L,C(C1(U))>. 
Therefore, when analyzing the lambda `(\x -> ...)`, we
expect each lambda \y -> ... to be annotated as "one-shot"
one. Therefore (\x -> \y -> x (y ++ z)) should be analyzed with a
demand <C(C(..), C(C1(U))>.

This is achieved by, first, converting the lazy demand L into the
strict S by the second clause of the analysis.

%************************************************************************
%*                                                                      *
                     Demand signatures
%*                                                                      *
%************************************************************************

In a let-bound Id we record its strictness info.  
In principle, this strictness info is a demand transformer, mapping
a demand on the Id into a DmdType, which gives
        a) the free vars of the Id's value
        b) the Id's arguments
        c) an indication of the result of applying 
           the Id to its arguments

However, in fact we store in the Id an extremely emascuated demand
transfomer, namely

                a single DmdType
(Nevertheless we dignify StrictSig as a distinct type.)

This DmdType gives the demands unleashed by the Id when it is applied
to as many arguments as are given in by the arg demands in the DmdType.

If an Id is applied to less arguments than its arity, it means that
the demand on the function at a call site is weaker than the vanilla
call demand, used for signature inference. Therefore we place a top
demand on all arguments. Otherwise, the demand is specified by Id's
signature.

For example, the demand transformer described by the DmdType
                DmdType {x -> <S(LL),U(UU)>} [V,A] Top
says that when the function is applied to two arguments, it
unleashes demand <S(LL),U(UU)> on the free var x, V on the first arg,
and A on the second.  

If this same function is applied to one arg, all we can say is that it
uses x with <L,U>, and its arg with demand <L,U>.

\begin{code}
<pre><a name="line-1"></a><a name="StrictSig"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-conid'>DmdType</span>
<a name="line-2"></a>                  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="instance%20Outputable%20StrictSig"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="mkStrictSig"></a><span class='hs-definition'>mkStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-8"></a><span class='hs-definition'>mkStrictSig</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="splitStrictSig"></a><span class='hs-definition'>splitStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdResult</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-definition'>splitStrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="increaseStrictSigArity"></a><span class='hs-definition'>increaseStrictSigArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-14"></a><span class='hs-comment'>-- Add extra arguments to a strictness signature</span>
<a name="line-15"></a><span class='hs-definition'>increaseStrictSigArity</span> <span class='hs-varid'>arity_increase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>arity_increase</span> <span class='hs-varid'>topDmd</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dmds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="isTopSig"></a><span class='hs-definition'>isTopSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-19"></a><span class='hs-definition'>isTopSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTopDmdType</span> <span class='hs-varid'>ty</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="isBottomingSig"></a><span class='hs-definition'>isBottomingSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-22"></a><span class='hs-definition'>isBottomingSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBotRes</span> <span class='hs-varid'>res</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="topSig"></a><span class='hs-definition'>topSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>botSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span>
<a name="line-25"></a><span class='hs-definition'>topSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>topDmdType</span>
<a name="line-26"></a><a name="botSig"></a><span class='hs-definition'>botSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>botDmdType</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="cprProdSig"></a><span class='hs-definition'>cprProdSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span>
<a name="line-29"></a><span class='hs-definition'>cprProdSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>cprProdDmdType</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="argsOneShots"></a><span class='hs-definition'>argsOneShots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a><span class='hs-definition'>argsOneShots</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n_val_args</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arg_ds</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>n_val_args</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>   <span class='hs-comment'>-- Too few arguments</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg_ds</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-39"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_d</span> <span class='hs-conop'>:</span> <span class='hs-varid'>arg_ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>argOneShots</span> <span class='hs-varid'>arg_d</span> <span class='hs-varop'>`cons`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg_ds</span>
<a name="line-40"></a>    
<a name="line-41"></a>    <span class='hs-varid'>cons</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-42"></a>    <span class='hs-varid'>cons</span> <span class='hs-varid'>a</span>  <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="argOneShots"></a><span class='hs-definition'>argOneShots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a><span class='hs-definition'>argOneShots</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usg</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>usg</span> <span class='hs-keyword'>of</span>
<a name="line-47"></a>      <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_usg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg_usg</span>
<a name="line-48"></a>      <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-49"></a>  <span class='hs-keyword'>where</span>
<a name="line-50"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span>  <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>u</span>
<a name="line-51"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>u</span>
<a name="line-52"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="dmdTransformSig"></a><span class='hs-definition'>dmdTransformSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-55"></a><span class='hs-comment'>-- (dmdTransformSig fun_sig dmd) considers a call to a function whose</span>
<a name="line-56"></a><span class='hs-comment'>-- signature is fun_sig, with demand dmd.  We return the demand</span>
<a name="line-57"></a><span class='hs-comment'>-- that the function places on its context (eg its args)</span>
<a name="line-58"></a><span class='hs-definition'>dmdTransformSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-59"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>str</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd_ty2</span>
<a name="line-61"></a>  <span class='hs-keyword'>where</span>
<a name="line-62"></a>    <span class='hs-varid'>dmd_ty1</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>str_sat</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-63"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferType</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-64"></a>    <span class='hs-varid'>dmd_ty2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>abs_sat</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd_ty1</span>
<a name="line-65"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>useType</span> <span class='hs-varid'>dmd_ty1</span>
<a name="line-66"></a>
<a name="line-67"></a>    <span class='hs-varid'>str_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_str</span> <span class='hs-varid'>arg_ds</span> <span class='hs-varid'>str</span>
<a name="line-68"></a>    <span class='hs-varid'>abs_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_abs</span> <span class='hs-varid'>arg_ds</span> <span class='hs-varid'>abs</span>
<a name="line-69"></a>
<a name="line-70"></a>    <span class='hs-varid'>go_str</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-71"></a>    <span class='hs-varid'>go_str</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>HyperStr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>         <span class='hs-comment'>-- HyperStr = Call(HyperStr)</span>
<a name="line-72"></a>    <span class='hs-varid'>go_str</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>d'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_str</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>d'</span>
<a name="line-73"></a>    <span class='hs-varid'>go_str</span> <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-74"></a>
<a name="line-75"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-conid'>[]</span>      <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-76"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span> <span class='hs-varid'>d'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_abs</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>d'</span>
<a name="line-77"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-comment'>-- NB: it's important to use deferType, and not just return topDmdType</span>
<a name="line-80"></a>    <span class='hs-comment'>-- Consider     let { f x y = p + x } in f 1</span>
<a name="line-81"></a>    <span class='hs-comment'>-- The application isn't saturated, but we must nevertheless propagate </span>
<a name="line-82"></a>    <span class='hs-comment'>--      a lazy demand for p!  </span>
<a name="line-83"></a>
<a name="line-84"></a><a name="dmdTransformDataConSig"></a><span class='hs-definition'>dmdTransformDataConSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-85"></a><span class='hs-comment'>-- Same as dmdTranformSig but for a data constructor (worker), </span>
<a name="line-86"></a><span class='hs-comment'>-- which has a special kind of demand transformer.</span>
<a name="line-87"></a><span class='hs-comment'>-- If the constructor is saturated, we feed the demand on </span>
<a name="line-88"></a><span class='hs-comment'>-- the result into the constructor arguments.</span>
<a name="line-89"></a><span class='hs-definition'>dmdTransformDataConSig</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con_res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-90"></a>                             <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>str</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>str_dmds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_str</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>str</span>
<a name="line-92"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>abs_dmds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_abs</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>abs</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkJointDmds</span> <span class='hs-varid'>str_dmds</span> <span class='hs-varid'>abs_dmds</span><span class='hs-layout'>)</span> <span class='hs-varid'>con_res</span>
<a name="line-94"></a>                <span class='hs-comment'>-- Must remember whether it's a product, hence con_res, not TopRes</span>
<a name="line-95"></a>
<a name="line-96"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Not saturated</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topDmdType</span>
<a name="line-98"></a>  <span class='hs-keyword'>where</span>
<a name="line-99"></a>    <span class='hs-varid'>go_str</span> <span class='hs-num'>0</span> <span class='hs-varid'>dmd</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitStrProdDmd</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span>
<a name="line-100"></a>    <span class='hs-varid'>go_str</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_str</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>s'</span>
<a name="line-101"></a>    <span class='hs-varid'>go_str</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-102"></a>   
<a name="line-103"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-num'>0</span> <span class='hs-varid'>dmd</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitUseProdDmd</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span>
<a name="line-104"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span> <span class='hs-varid'>u'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_abs</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>u'</span>
<a name="line-105"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

Note [Non-full application] 
~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
If a function having bottom as its demand result is applied to a less
number of arguments than its syntactic arity, we cannot say for sure
that it is going to diverge. This is the reason why we use the
function appIsBottom, which, given a strictness signature and a number
of arguments, says conservatively if the function is going to diverge
or not.

\begin{code}
<pre><a name="line-1"></a><a name="appIsBottom"></a><span class='hs-comment'>-- appIsBottom returns true if an application to n args would diverge</span>
<a name="line-2"></a><span class='hs-definition'>appIsBottom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3"></a><span class='hs-definition'>appIsBottom</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-4"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBotRes</span> <span class='hs-varid'>res</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lengthExceeds</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>n</span> 
<a name="line-5"></a><span class='hs-definition'>appIsBottom</span> <span class='hs-keyword'>_</span>                                 <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="seqStrictSig"></a><span class='hs-definition'>seqStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-8"></a><span class='hs-definition'>seqStrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqDmdType</span> <span class='hs-varid'>ty</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="pprIfaceStrictSig"></a><span class='hs-comment'>-- Used for printing top-level strictness pragmas in interface files</span>
<a name="line-11"></a><span class='hs-definition'>pprIfaceStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-12"></a><span class='hs-definition'>pprIfaceStrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dmds</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res</span>
</pre>\end{code}

Zap absence or one-shot information, under control of flags

\begin{code}
<pre><a name="line-1"></a><a name="zapDemand"></a><span class='hs-definition'>zapDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-2"></a><span class='hs-definition'>zapDemand</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dmd</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kfs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>killFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zap_dmd</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>dmd</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="zapStrictSig"></a><span class='hs-definition'>zapStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-7"></a><span class='hs-definition'>zapStrictSig</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kfs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>killFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_dmd</span> <span class='hs-varid'>kfs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="KillFlags"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="killFlags"></a><span class='hs-definition'>killFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>KillFlags</span>
<a name="line-14"></a><span class='hs-definition'>killFlags</span> <span class='hs-varid'>dflags</span> 
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>kill_abs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>kill_one_shot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>kill_abs</span><span class='hs-layout'>,</span> <span class='hs-varid'>kill_one_shot</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyword'>where</span>
<a name="line-18"></a>    <span class='hs-varid'>kill_abs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KillAbsence</span> <span class='hs-varid'>dflags</span>
<a name="line-19"></a>    <span class='hs-varid'>kill_one_shot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KillOneShot</span> <span class='hs-varid'>dflags</span>
<a name="line-20"></a>      
<a name="line-21"></a><a name="zap_dmd"></a><span class='hs-definition'>zap_dmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-22"></a><span class='hs-definition'>zap_dmd</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zap_musg</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="zap_musg"></a><span class='hs-definition'>zap_musg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-25"></a><span class='hs-definition'>zap_musg</span> <span class='hs-layout'>(</span><span class='hs-varid'>kill_abs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conid'>Abs</span> 
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kill_abs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>useTop</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-28"></a><span class='hs-definition'>zap_musg</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_count</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_usg</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="zap_count"></a><span class='hs-definition'>zap_count</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span>
<a name="line-31"></a><span class='hs-definition'>zap_count</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>kill_one_shot</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kill_one_shot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="zap_usg"></a><span class='hs-definition'>zap_usg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-36"></a><span class='hs-definition'>zap_usg</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_count</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_usg</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-definition'>zap_usg</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_musg</span> <span class='hs-varid'>kfs</span><span class='hs-layout'>)</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-definition'>zap_usg</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>u</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                     Serialisation
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="instance%20Binary%20StrDmd"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>HyperStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-3"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>HeadStr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-4"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-5"></a>                            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>s</span>
<a name="line-6"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>3</span>
<a name="line-7"></a>                            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>sx</span>  
<a name="line-8"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-9"></a>         <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-10"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>           <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>return</span> <span class='hs-conid'>HyperStr</span>
<a name="line-12"></a>           <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>return</span> <span class='hs-conid'>HeadStr</span>
<a name="line-13"></a>           <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>s</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-14"></a>                   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-15"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>sx</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-16"></a>                   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="instance%20Binary%20MaybeStr"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Lazy</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-20"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-21"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-22"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-23"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>s</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-26"></a>            <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-27"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span> 
<a name="line-28"></a>              <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Lazy</span>
<a name="line-29"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>s</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-30"></a>                      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Str</span> <span class='hs-varid'>s</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="instance%20Binary%20Count"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>Count</span> <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>One</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-34"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Many</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-35"></a>    
<a name="line-36"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-37"></a>                 <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>                   <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>One</span>
<a name="line-39"></a>                   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Many</span>   
<a name="line-40"></a>
<a name="line-41"></a><a name="instance%20Binary%20MaybeUsed"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Abs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-43"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-44"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-45"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-46"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>c</span>
<a name="line-47"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>u</span>
<a name="line-48"></a>
<a name="line-49"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-50"></a>            <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-51"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span> 
<a name="line-52"></a>              <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Abs</span>       
<a name="line-53"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>c</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-54"></a>                      <span class='hs-varid'>u</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-55"></a>                      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="instance%20Binary%20UseDmd"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyword'>where</span>
<a name="line-58"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Used</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-59"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-60"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>UHead</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-61"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-62"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-63"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-64"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>c</span>
<a name="line-65"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>u</span>
<a name="line-66"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-67"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>3</span>
<a name="line-68"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>ux</span>
<a name="line-69"></a>
<a name="line-70"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-71"></a>            <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-72"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span> 
<a name="line-73"></a>              <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Used</span>
<a name="line-74"></a>              <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>UHead</span>
<a name="line-75"></a>              <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-76"></a>                      <span class='hs-varid'>u</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-77"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-78"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ux</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-79"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="instance%20Binary%20JointDmd"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyword'>where</span>
<a name="line-82"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>y</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>y</span>
<a name="line-83"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-84"></a>              <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-85"></a>              <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-86"></a>              <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="instance%20Binary%20StrictSig"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyword'>where</span>
<a name="line-89"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>aa</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-90"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>aa</span>
<a name="line-91"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-92"></a>          <span class='hs-varid'>aa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-93"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>aa</span><span class='hs-layout'>)</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="instance%20Binary%20DmdType"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyword'>where</span>
<a name="line-96"></a>  <span class='hs-comment'>-- Ignore DmdEnv when spitting out the DmdType</span>
<a name="line-97"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>dr</span><span class='hs-layout'>)</span> 
<a name="line-98"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>ds</span> 
<a name="line-99"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>dr</span>
<a name="line-100"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> 
<a name="line-101"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> 
<a name="line-102"></a>           <span class='hs-varid'>dr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> 
<a name="line-103"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>dr</span><span class='hs-layout'>)</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="instance%20Binary%20CPRResult"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyword'>where</span>
<a name="line-106"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>RetProd</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-108"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>NoCPR</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-109"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>BotCPR</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>3</span>
<a name="line-110"></a>
<a name="line-111"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-112"></a>            <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-113"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span> 
<a name="line-114"></a>              <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-115"></a>              <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>RetProd</span>
<a name="line-116"></a>              <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>NoCPR</span>
<a name="line-117"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>BotCPR</span>
</pre>\end{code}

</body>
</html>
